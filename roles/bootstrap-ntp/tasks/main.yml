---

- name: Include OS-specific variables.
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution }}-{{ ansible_distribution_major_version}}.yml"
    - "{{ ansible_distribution }}.yml"
    - "{{ ansible_os_family }}.yml"
    - "default.yml"

- debug:
    var: bootstrap_ntp_servers

#- name "Set __bootstrap_ntp_servers"
#  set_fact:
#    __bootstrap_ntp_servers: "{{ __bootstrap_ntp_servers|d([]) }}"

#- name "Set __bootstrap_ntp_servers"
#  set_fact:
##    __bootstrap_ntp_servers: "{{ __bootstrap_ntp_servers|d([]) + [ item|string + ' ' + bootstrap_ntp_server_options ] }}"
#    __bootstrap_ntp_servers: "{{ __bootstrap_ntp_servers|d([]) + [ item ] }}"
#  loop: bootstrap_ntp_servers

- debug:
    var: __bootstrap_ntp_servers

- name: When chronyd is used, assert that the ntpd service is not installed/running
  when: __bootstrap_ntp_daemon == 'chronyd'
  block:
    ## ref: https://stackoverflow.com/questions/30328506/check-if-service-exists-with-ansible
    - name: Populate service facts to determine if ntpd is installed
      service_facts:

#    - name: Assert ntpd service is not installed/running when intended service is chronyd
#      assert:
#        that:
#          - "'ntpd' not in services"
#          - "'ntpd.service' not in services"

    - name: Remove ntpd service when intended service is chronyd
      when:
        - "'ntpd' not in services"
        - "'ntpd.service' not in services"
      block:

        - name: Ensure ntpd service is stopped and disabled
          ignore_errors: yes
          service:
            name: item
            state: stopped
            enabled: false
          loop:
            - ntpd
            - ntpd.service

        - name: Ensure ntp package is uninstalled
          package:
            name: ntp
            state: absent


- name: Display bootstrap_ntp_var_source
  debug:
    var: bootstrap_ntp_var_source

- name: Display bootstrap_ntp_servers
  debug:
    var: bootstrap_ntp_servers

- name: Display bootstrap_ntp_peers
  when: bootstrap_ntp_peers|d([])|length>0
  debug:
    var: bootstrap_ntp_peers

- name: Display bootstrap_ntp_cmdport_disabled
  debug:
    var: bootstrap_ntp_cmdport_disabled

- name: Display bootstrap_ntp_allow_networks
  debug:
    var: bootstrap_ntp_allow_networks

- name: Display bootstrap_ntp_restrict
  debug:
    var: bootstrap_ntp_restrict

- name: "Set __bootstrap_ntp_restrict"
  set_fact:
    __bootstrap_ntp_restrict: "{{ bootstrap_ntp_restrict|d([]) }}"

## https://docs.ansible.com/ansible/latest/collections/ansible/utils/docsite/filters_ipaddr.html#filtering-lists
- name: "Add bootstrap_ntp_allow_networks to __bootstrap_ntp_restrict by converting the CIDR to netmask"
  set_fact:
    __bootstrap_ntp_restrict: "{{ __bootstrap_ntp_restrict|d([]) + [ item|ansible.utils.ipaddr('network') +' mask ' + item|ansible.utils.ipaddr('netmask')|string + ' notrust'] }}"
#    __bootstrap_ntp_restrict: "{{ __bootstrap_ntp_restrict|d([]) + [ item|ipaddr('network') +' mask ' + item|ipaddr('netmask')|string + ' notrust'] }}"
  loop: "{{ bootstrap_ntp_allow_networks }}"

- name: "Uniquify __bootstrap_ntp_restrict"
  set_fact:
    __bootstrap_ntp_restrict: "{{ __bootstrap_ntp_restrict|d([]) | sort | unique }}"

- name: Display __bootstrap_ntp_restrict
  debug:
    var: __bootstrap_ntp_restrict

- name: "Set __bootstrap_ntp_allow_networks"
  set_fact:
    __bootstrap_ntp_allow_networks: "{{ bootstrap_ntp_allow_networks|d([]) }}"

## ref: https://docs.ansible.com/ansible/latest/collections/ansible/utils/docsite/filters_ipaddr.html#filtering-lists
- name: "Add bootstrap_ntp_restrict to __bootstrap_ntp_allow_networks by converting the netmask to CIDR"
  set_fact:
    __bootstrap_ntp_allow_networks: "{{ __bootstrap_ntp_allow_networks|d([]) + [ item | regex_replace('(.*) mask ([.0-9]+)\\s?(.*)', '\\1/\\2') | ansible.utils.ipaddr('network/prefix') ] }}"
#    __bootstrap_ntp_allow_networks: "{{ __bootstrap_ntp_allow_networks|d([]) + [ item | regex_replace('(.*) mask ([.0-9]+)\\s?(.*)', '\\1/\\2') | ipaddr('network/prefix') ] }}"
  loop: "{{ bootstrap_ntp_allow_networks }}"

- name: "Uniquify __bootstrap_ntp_allow_networks"
  set_fact:
    __bootstrap_ntp_allow_networks: "{{ __bootstrap_ntp_allow_networks|d([]) | sort | unique }}"

- name: Display __bootstrap_ntp_allow_networks
  debug:
    var: __bootstrap_ntp_allow_networks

- name: Set bootstrap_ntp_driftfile
  when: bootstrap_ntp_driftfile is not defined
  set_fact:
    bootstrap_ntp_driftfile: "{{ __bootstrap_ntp_driftfile }}"

- name: Set bootstrap_ntp_package
  when: bootstrap_ntp_package is not defined
  set_fact:
    bootstrap_ntp_package: "{{ __bootstrap_ntp_package }}"

- name: Set bootstrap_ntp_config_file
  when: bootstrap_ntp_config_file is not defined
  set_fact:
    bootstrap_ntp_config_file: "{{ __bootstrap_ntp_config_file }}"

- name: Set bootstrap_ntp_daemon
  when: bootstrap_ntp_daemon is not defined
  set_fact:
    bootstrap_ntp_daemon: "{{ __bootstrap_ntp_daemon }}"

- name: "Ensure {{ bootstrap_ntp_package }} package is installed."
  package:
    name: "{{ bootstrap_ntp_package }}"
    state: present

- name: "Ensure {{ bootstrap_ntp_tzdata_package }} package is installed (Linux)."
  when: ansible_system == "Linux"
  package:
    name: "{{ bootstrap_ntp_tzdata_package }}"
    state: present

- name: "Set timezone to {{ bootstrap_ntp_timezone }}."
  timezone:
    name: "{{ bootstrap_ntp_timezone }}"
  notify: restart cron

- name: Populate service facts.
  service_facts:

- name: Disable systemd-timesyncd if it's running but ntp is enabled.
  when:
    - bootstrap_ntp_enabled | bool
    - '"systemd-timesyncd.service" in services'
    - services["systemd-timesyncd.service"]["status"] != "not-found"
  service:
    name: systemd-timesyncd.service
    enabled: false
    state: stopped

- name: "Ensure {{ bootstrap_ntp_daemon }} is stopped and disabled as configured."
  when: not (bootstrap_ntp_enabled | bool)
  ignore_errors: yes
  service:
    name: "{{ bootstrap_ntp_daemon }}"
    state: stopped
    enabled: false

- name: Generate ntp configuration file.
  when: bootstrap_ntp_manage_config | bool
  template:
    src: "{{ bootstrap_ntp_config_file | basename }}.j2"
    dest: "{{ bootstrap_ntp_config_file }}"
    mode: 0644
    backup: yes
  notify: restart ntp

- name: "Ensure {{ bootstrap_ntp_daemon }} is running and enabled as configured."
  when: bootstrap_ntp_enabled | bool
  service:
    name: "{{ bootstrap_ntp_daemon }}"
    state: restarted
    enabled: true

