---

- name: Docker | Docker Compose | Check current docker-compose version.
  command: "{{ bootstrap_docker__compose_path }} --version"
  register: __bootstrap_docker__compose_vsn
  check_mode: false
  changed_when: false
  failed_when: false

- name: Docker | Docker Compose | Set __bootstrap_docker__compose_current_version
  set_fact:
    __bootstrap_docker__compose_current_version: "{{ __bootstrap_docker__compose_vsn.stdout | regex_search('(\\d+(\\.\\d+)+)') }}"
  when: >
    __bootstrap_docker__compose_vsn.stdout is defined
    and (__bootstrap_docker__compose_vsn.stdout | length > 0)

- name: Docker | Docker Compose | Init __replace_docker_compose
  set_fact:
    __replace_docker_compose: no

- name: Docker | Docker Compose | Set __replace_docker_compose
  when: >
    __bootstrap_docker__compose_current_version is not defined
    or (__bootstrap_docker__compose_current_version | length == 0)
  set_fact:
    __replace_docker_compose: yes

- name: Docker | Docker Compose | Set __replace_docker_compose
  when:
    - bootstrap_docker__compose_version is defined
    - (bootstrap_docker__compose_version | regex_replace('v', '')) not in __bootstrap_docker__compose_current_version
  set_fact:
    __replace_docker_compose: yes

- name: Docker | Docker Compose | Replace existing docker-compose
  when: __replace_docker_compose|bool
  block:

    - name: Docker | Docker Compose | Delete existing docker-compose version if it's different.
      file:
        path: "{{ bootstrap_docker__compose_path }}"
        state: absent

    - name: Docker | Docker Compose | Install Docker Compose (if configured).
      get_url:
        url: "{{ bootstrap_docker__compose_url }}"
        dest: "{{ bootstrap_docker__compose_path }}"
        mode: 0755

#########
## ADDITIONAL ENV SETUP
#########

- name: Docker | Docker Compose | Install Python docker packages
#  become: yes
#  become_user: "{{ ansible_local_user }}"
#  vars:
#    ansible_ssh_pipelining: yes
  pip:
    name: >
      {{ item.name }}{% if item.version | d() %}=={{ item.version }}{% endif %}
    state: "{{ item.state | d('present') }}"
    executable: pip3
  loop: "{{ bootstrap_docker__default_pip_packages + bootstrap_docker__pip_packages }}"
  when: item.name | d()

## Unable to find pip in the virtualenv (python 3.10)
## https://github.com/ansible/ansible/issues/77604
- name: Docker | Docker Compose | Install Python docker packages into docker-python virtualenv
#  become: yes
  pip:
    name: >
      {{ item.name }}{% if item.version | d() %}=={{ item.version }}{% endif %}
    state: "{{ item.virtualenv_state | d('present') }}"
    extra_args: "--user"
    virtualenv: "{{ bootstrap_docker__pip_virtualenv }}"
    virtualenv_site_packages: yes
    virtualenv_python: python3
#    virtualenv_command: "{{ bootstrap_docker__python_virtualenv_command | d(omit) }}"
#    virtualenv_python: "{{ 'python3' if (bootstrap_docker__python_virtualenv_command is not defined) else omit }}"
#    executable: "pip3"
  loop: "{{ bootstrap_docker__default_pip_packages + bootstrap_docker__pip_packages }}"
  when: item.name | d()
  environment:
    SETUPTOOLS_USE_DISTUTILS: stdlib

- name: Docker | Docker Compose | Symlink Docker Python binary to {{ ansible_python_docker_interpreter }}
  file:
    path: "{{ ansible_python_docker_interpreter }}"
    src: "{{ bootstrap_docker__pip_virtualenv }}/bin/python"
    state: link

#- name: Docker | Docker Compose | Symlink selected Python package binaries to /usr/local/bin
#  file:
#    path: "{{ item.path }}"
#    src: "{{ item.src }}"
#    state: "link"
#  loop: "{{ bootstrap_docker__default_pip_packages + bootstrap_docker__pip_packages }}"
#  when:
#    - item.state | d("present") != "absent"
#    - item.path | d() and item.src | d()

