---

- name: "{{ __docker_stack__log_prefix__handle_service_exc }} Assert __configure_docker_service is defined"
  assert:
    that: __configure_docker_service is defined

- name: "{{ __docker_stack__log_prefix__handle_service_exc }} Display __configure_docker_service"
  debug:
    var: __configure_docker_service

- name: "{{ __docker_stack__log_prefix__handle_service_exc }} Set __ip_table_error"
  when:
    - item.failed|d(False)|bool
    - (item.msg is search('Failed to Setup IP tables') or item.msg is search('INVALID_ZONE.* docker') )
  set_fact:
    __ip_table_error: yes
  loop: "{{ __configure_docker_service.results|d([]) }}"

- name: "{{ __docker_stack__log_prefix__handle_service_exc }} Display __ip_table_error"
  debug:
    var: __ip_table_error

- name: "{{ __docker_stack__log_prefix__handle_service_exc }} Re-emit failure"
  when: not __ip_table_error|d(False)|bool
  vars:
    failed_task:
      result: "{{ ansible_failed_result }}"
  fail:
    msg: "{{ failed_task }}"

- name: "{{ __docker_stack__log_prefix__handle_service_exc }} Restart docker daemon"
  include_tasks: restart-docker-daemon.yml
