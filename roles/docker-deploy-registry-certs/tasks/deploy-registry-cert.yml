---

- name: "get_certs_from_keyring | Ensure {{ ca_keyring_certs_dir }} exists"
  file:
    path: "{{ ca_keyring_certs_dir }}"
    state: directory
    mode: 0755

- name: "get_certs_from_keyring | Display cacert_keyring_host"
  debug:
    msg:
      - "cacert_keyring_host={{cacert_keyring_host}}"
      - "ansible_ssh_user={{ansible_ssh_user}}"

- name: "get_certs_from_keyring | Copy registry cert {{ docker_registry_info.host }}.chain.pem"
  delegate_to: "localhost"
  shell: >
    rsync -arP -e'ssh -o StrictHostKeyChecking=no'
    --rsync-path 'sudo -u root rsync'
    {{ ansible_ssh_user }}@{{ cacert_keyring_host }}:{{ keyring_cacerts_base_dir }}/{{ docker_registry_info.host }}/{{ docker_registry_info.host }}.chain.pem
    {{ ca_keyring_certs_dir }}/{{ docker_registry_info.host }}.pem

- name: "get_certs_from_keyring | Ensure directory exists for CA signed TLS certs."
  file:
    path: "/etc/docker/certs.d/{{ docker_registry_info.endpoint }}"
    state: directory

## ref: https://codeblog.dotsandbrackets.com/private-registry-swarm/
- name: "get_certs_from_keyring | Copy {{ docker_registry_info.certname }} certs to docker node"
  copy:
    src: "{{ ca_local_cert_dir }}/{{ docker_registry_info.certname }}"
    dest: "/etc/docker/certs.d/{{ docker_registry_info.endpoint }}/ca.crt"
