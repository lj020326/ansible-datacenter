---

- name: "webmin | Include OS vars"
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version }}.yml"
    - "{{ ansible_distribution | lower }}.yml"
    - "{{ ansible_os_family | lower }}.yml"
    - "default.yml"

- name: "webmin | Display bootstrap_webmin__packages"
  debug:
    var: bootstrap_webmin__packages

- name: "webmin | Installing Packages required by webmin"
  when: bootstrap_webmin__packages|d([])|length>0
  ansible.builtin.package:
    name: "{{ bootstrap_webmin__packages }}"
    state: present

## Setting the PERL_MM_USE_DEFAULT env var makes perl automatically answer "yes"
## when CPAN asks "Would you like to configure as much as possible automatically? [yes]"
- name: "webmin | Install automatically perl module PERL_MM_USE_DEFAULT"
  ansible.builtin.shell: "echo $PERL_MM_USE_DEFAULT"
  changed_when: no
  environment:
   PERL_MM_USE_DEFAULT: 1

- name: "webmin | Echo PERL_MM_USE_DEFAULT again"
  ansible.builtin.shell: "echo $PERL_MM_USE_DEFAULT"
  changed_when: no

- name: "webmin | Check perl"
  environment:
   PERL_MM_USE_DEFAULT: 1
  ansible.builtin.shell: perl -e 'use FileHandle; print $FileHandle::VERSION'
  changed_when: no
  become: true

- name: "webmin | Install webmin"
  ansible.builtin.include_tasks: "install-{{ ansible_os_family|lower }}.yml"

- name: "webmin | Configure webmin users"
  when: bootstrap_webmin__users|d([])|length > 0
  ansible.builtin.include_tasks: setup-users.yml

- name: "webmin | Download and install webmin modules"
  when: bootstrap_webmin__modules|d([])|length > 0
  ansible.builtin.include_tasks: setup-modules.yml
