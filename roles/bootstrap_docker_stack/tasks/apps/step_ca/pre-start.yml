---
- name: Docker Stack | StepCA | pre-start | Initialize __cert_validation_results_failed
  ansible.builtin.set_fact:
    __cert_validation_results_failed: false

- name: Docker Stack | StepCA | pre-start | Check if CA cert signature is valid (so we don't generate a new on on every run)
  when: docker_stack__stepca__enable_signed
  block:
#        ## ref: https://docs.ansible.com/ansible/latest/modules/openssl_certificate_info_module.html#openssl-certificate-info-module
#        - name: "Docker Stack | StepCA | pre-start | validate_cert | Get ca certificate info"
#          community.crypto.x509_certificate_info:
#            path: "{{ __docker_stack__stepca__home_dir }}/certs/intermediate_ca.crt"
#          register: cacert_result
#
#        - name: "Docker Stack | StepCA | pre-start | validate_cert | Display cacert_result"
#          when: cacert_display_cacert_result
#          ansible.builtin.debug:
#            var: cacert_result
#
#        - name: "Docker Stack | StepCA | pre-start | validate_cert | Assert cert info is valid"
#          ansible.builtin.assert:
#            that:
#              # issuer and issuer_strict
#              - cacert_result.issuer.organizationName == ca_signer_cert_info.organization
#              - cacert_result.issuer.commonName == ca_signer_cert_info.commonName
#              - cacert_result.subject.organizationName == ca_cert_info.organization
#              - cacert_result.subject.commonName == ca_cert_info.commonName
#              # has_expired
#              - not cacert_result.expired

    - name: Docker Stack | StepCA | pre-start | validate_cert | Validate signed by ca signer certs
      ansible.builtin.command: >
        openssl verify -CAfile
          {{ docker_stack__internal_ssl_cert_dir }}/ca.{{ docker_stack__internal_domain }}.chain.pem
          {{ __docker_stack__stepca__home_dir }}/certs/intermediate_ca.crt
      changed_when: false
      ignore_errors: true
      register: __cert_validity_signer

    - name: Docker Stack | StepCA | pre-start | validate_cert | Display __cert_validity_signer
      ansible.builtin.debug:
        var: __cert_validity_signer

    - name: Set __cert_validation_results_failed
      when: __cert_validity_signer.failed|d(False)|bool
      ansible.builtin.set_fact:
        __cert_validation_results_failed: true

- name: Docker Stack | StepCA | pre-start | Display __cert_validation_results_failed
  ansible.builtin.debug:
    var: __cert_validation_results_failed

- name: Docker Stack | StepCA | pre-start | Display docker_stack__stepca__ca_force_create
  ansible.builtin.debug:
    var: docker_stack__stepca__ca_force_create

- name: Docker Stack | StepCA | pre-start | Setup signed stepca cert
  when: __cert_validation_results_failed|bool or docker_stack__stepca__ca_force_create|bool
  block:
    - name: Docker Stack | StepCA | pre-start | Deploy step-ca's root, intermediate CA cert and key
      when: not docker_stack__stepca__enable_signed
      ansible.builtin.include_tasks: init-stepca-certs.yml

    - name: Docker Stack | StepCA | pre-start | Create signed intermediate cert
      when: docker_stack__stepca__enable_signed
      ansible.builtin.include_tasks: init-stepca-certs-signed.yml
