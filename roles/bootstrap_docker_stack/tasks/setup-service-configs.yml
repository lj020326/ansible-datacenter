---
- name: "{{ __docker_stack__log_prefix__service_config }} Display docker_stack__service_templates"
  ansible.builtin.debug:
    var: docker_stack__service_templates

- name: "{{ __docker_stack__log_prefix__service_config }} Display __docker_stack__port_mode"
  ansible.builtin.debug:
    var: __docker_stack__port_mode

- name: "{{ __docker_stack__log_prefix__service_config }} Install docker stack service templates"
  ansible.builtin.template:
    backup: "{{ item.backup | d(True) }}"
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    #    force: "{{ docker_stack__overwrite_configs }}"
    mode: "{{ item.mode | d('0664') }}"
    owner: "{{ docker_stack__user_username }}"
    group: "{{ docker_stack__user_group }}"
  loop: "{{ docker_stack__service_templates }}"

- name: "{{ __docker_stack__log_prefix__service_config }} Install docker stack proxy service templates"
  when: __docker_stack__proxy_services | length > 0
  ansible.builtin.template:
    backup: "{{ item.backup | d(True) }}"
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    #    force: "{{ docker_stack__overwrite_configs }}"
    mode: "{{ item.mode | d('0664') }}"
    owner: "{{ docker_stack__user_username }}"
    group: "{{ docker_stack__user_group }}"
  loop: "{{ docker_stack__proxy_service_templates }}"

- name: "{{ __docker_stack__log_prefix__service_config }} Display __docker_stack__secrets.keys()"
  when: __docker_stack__secrets | d({}) | length > 0
  ansible.builtin.debug:
    var: __docker_stack__secrets.keys()|list

#- name: "{{ __docker_stack__log_prefix__service_config }} Display __docker_stack__secrets"
#  ansible.builtin.debug:
#     var: __docker_stack__secrets
##     verbosity: 2

- name: "{{ __docker_stack__log_prefix__service_config }} Create docker secrets for stack if necessary"
  no_log: true
  when:
    - docker_stack__swarm_mode | d(False) | bool
    - docker_stack__swarm_manager | d(False) | bool
    - __docker_stack__secrets | d({}) | length > 0
  community.docker.docker_secret:
    name: "{{ item.name }}"
    data: "{{ item.value }}"
    labels: "{{ item.labels | d(omit) }}"
    state: present
  #    force: true
  loop: "{{ __docker_stack__secrets.values() }}"
  loop_control:
    label: "{{ item.name }}"
  register: __configure_docker_secrets

- name: "{{ __docker_stack__log_prefix__service_config }} Display __docker_stack__networks"
  ansible.builtin.debug:
    var: __docker_stack__networks
    verbosity: 1

#- name: "Shut down docker stack"
#  when: __docker_stack__networks | d({}) | length > 0
#  ansible.builtin.include_tasks: shutdown-docker-stack.yml

- name: "{{ __docker_stack__log_prefix__service_config }} Check if external Docker network exists"
  when:
    - (docker_stack__swarm_mode | d(False) | bool and docker_stack__swarm_manager | d(False) | bool)
      or not (docker_stack__swarm_mode | d(False) | bool)
    - item.value.external | d(False) | bool
  community.docker.docker_network:
    name: "{{ item.key }}"
    state: present
  with_dict: "{{ __docker_stack__networks }}"
  register: __network_check
  failed_when:
    - __network_check is failed
    - (__network_check.results | d([]) | selectattr('failed', 'equalto', True) |
       rejectattr('msg', 'search', 'network .* is in use by service') | list | length) > 0

- name: "{{ __docker_stack__log_prefix__service_config }} Display __network_check"
  ansible.builtin.debug:
    var: __network_check
    verbosity: 1

- name: "{{ __docker_stack__log_prefix__service_config }} Set __docker_stack__network_exists"
  ansible.builtin.set_fact:
    __docker_stack__network_exists: "{{ __docker_stack__network_exists | d({})
      | combine({item.item.key: (not item.changed)}) }}"
  loop: "{{ __network_check.results | d([]) }}"
  loop_control:
    label: "{{ item.item.key }}"

- name: "{{ __docker_stack__log_prefix__service_config }} Display __docker_stack__network_exists"
  ansible.builtin.debug:
    var: __docker_stack__network_exists

#- name: "{{ __docker_stack__log_prefix__service_config }} Create external docker networks for swarm if necessary"
#  when:
#    - docker_stack__swarm_mode | d(False) | bool
#    - docker_stack__swarm_manager | d(False) | bool
#    - item.value.external | d(False) | bool
#    # Only run if the check task failed (network didn't exist)
#    - not __docker_stack__network_exists[item.key]
#  community.docker.docker_network:
#    name: "{{ item.key }}"
#    attachable: "{{ item.value.attachable | d(omit) }}"
#    driver: "{{ item.value.driver | d(omit) }}"
#    ipam_config: "{{ item.value.ipam_config | d(omit) }}"
#    scope: "{{ item.value.scope | d('swarm' if (docker_stack__swarm_mode | d(False)) else 'local') }}"
#  with_dict: "{{ __docker_stack__networks }}"
#  register: __configure_docker_networks
#
#- name: "{{ __docker_stack__log_prefix__service_config }} Create external docker networks for stack if necessary"
#  when:
#    - not docker_stack__swarm_mode | d(False) | bool
#    - item.value.external | d(False) | bool
#  community.docker.docker_network:
#    name: "{{ item.key }}"
#    attachable: "{{ item.value.attachable | d(omit) }}"
#    scope: "{{ item.value.scope | d(omit) }}"
##        internal: "{{ (not item.value.external) | d(omit) }}"
#    ipam_config: "{{ item.value.ipam_config | d(omit) }}"
##    ipam_config: "{{ item.value.ipam.config | d(omit) }}"
#  with_dict: "{{ __docker_stack__networks }}"
#  register: __configure_docker_networks

- name: "{{ __docker_stack__log_prefix__service_config }} Create external docker networks if necessary"
  when:
    - (docker_stack__swarm_mode | d(False) | bool and docker_stack__swarm_manager | d(False) | bool)
      or not (docker_stack__swarm_mode | d(False) | bool)
    - item.value.external | d(False) | bool
    # Only run if the check task failed (network didn't exist)
    - not __docker_stack__network_exists[item.key]
  community.docker.docker_network:
    name: "{{ item.key }}"
    attachable: "{{ item.value.attachable | d(omit) }}"
    driver: "{{ item.value.driver | d(omit) }}"
    ipam_config: "{{ item.value.ipam_config | d(omit) }}"
    scope: "{{ item.value.scope | d('swarm' if (docker_stack__swarm_mode | d(False)) else omit) }}"
  with_dict: "{{ __docker_stack__networks }}"
  register: __configure_docker_networks
