---

__docker_stack__base__stack_dir: "{{ docker_stack__dir | d('/home/user/docker-dirs') }}"

#__docker_stack__traefik__host_default: "leader.example.int"
#__docker_stack__traefik__host_default: "{{ ansible_facts['fqdn'] | d(inventory_hostname) }}"
__docker_stack__traefik__host_default: "{{ ansible_facts['fqdn'] | d(inventory_hostname) }}"
__docker_stack__traefik__host: "{{ docker_stack__traefik__host | d(__docker_stack__traefik__host_default) }}"

__docker_stack__traefik__node_default: "{{ inventory_hostname }}"
__docker_stack__traefik__node: "{{ docker_stack__traefik__node | d(__docker_stack__traefik__host_default) }}"

__docker_stack__traefik__enable_prometheus: "{{ docker_stack__traefik__enable_prometheus | d(true) }}"

__docker_stack__traefik__certresolver_enable_qa: "{{ docker_stack__traefik__certprovider_qa | d(false) | bool }}"

#__docker_stack__traefik__certresolver_default: "{{ 'letsencrypt-qa'
#    if __docker_stack__traefik__certresolver_enable_qa else 'letsencrypt' }}"
__docker_stack__traefik__certresolver_external_default: "letsencrypt"
__docker_stack__traefik__certresolver_external: "{{ docker_stack__traefik__certresolver_external
  | d(__docker_stack__traefik__certresolver_external_default) }}"

__docker_stack__traefik__certresolver_default: "stepca"
__docker_stack__traefik__certresolver: "{{ docker_stack__traefik__certresolver
  | d(__docker_stack__traefik__certresolver_default) }}"

__docker_stack__traefik__certresolver_acme_file_qa: acme-qa.json
__docker_stack__traefik__certresolver_acme_file_prod: acme.json
__docker_stack__traefik__certresolver_acme_file: "{{ __docker_stack__traefik__certresolver_acme_file_qa
  if __docker_stack__traefik__certresolver_enable_qa
  else __docker_stack__traefik__certresolver_acme_file_prod }}"

__docker_stack__traefik__certresolver_stepca_url_default: "https://stepca.example.int"
__docker_stack__traefik__certresolver_stepca_url: "{{ docker_stack__traefik__certresolver_stepca_url
  | d(__docker_stack__traefik__certresolver_stepca_url_default) }}"

#__docker_stack__traefik__certresolver_stepca_certificates_duration_default: 24
__docker_stack__traefik__certresolver_stepca_certificates_duration_default: 8760
__docker_stack__traefik__certresolver_stepca_certificates_duration: "{{
  docker_stack__traefik__certresolver_stepca_certificates_duration
  | d(__docker_stack__traefik__certresolver_stepca_certificates_duration_default) }}"

__docker_stack__traefik__version: "{{ docker_stack__traefik__version | d('v2') }}"

__docker_stack__traefik__dirs:
  v1: "{{ __docker_stack__base__stack_dir }}/traefik1"
  v2: "{{ __docker_stack__base__stack_dir }}/traefik2"

__docker_stack__traefik__dir_default: "{{ __docker_stack__base__stack_dir }}/traefik"
__docker_stack__traefik__dir: "{{ __docker_stack__traefik__dirs[__docker_stack__traefik__version] | d(__docker_stack__traefik__dir_default) }}"

__docker_stack__traefik__http_port: "{{ docker_stack__traefik__http_port | d(80) | int }}"
__docker_stack__traefik__https_port: "{{ docker_stack__traefik__https_port | d(443) | int }}"
#__docker_stack__traefik__port: "{{ (':' + __docker_stack__traefik__https_port | string)
#  if __docker_stack__traefik__https_port != 443 else '' }}"

__docker_stack__traefik__https_entrypoints_default:
  address: ":{{ docker_stack__traefik__https_port }}"
  forwardedHeaders:
    trustedIPs:
      - "{{ docker_stack__host_network }}"
#      - 192.168.0.0/16
#      - 172.0.0.0/8

__docker_stack__traefik__https_entrypoints: "{{ docker_stack__traefik__https_entrypoints
  | d(__docker_stack__traefik__https_entrypoints_default) }}"

__docker_stack__base__cert_dump_dir_default: "{{ __docker_stack__base__stack_dir }}/shared/certs"
__docker_stack__base__cert_dump_dir: "{{ docker_stack__external_ssl_cert_dir | d(__docker_stack__base__cert_dump_dir_default) }}"

__docker_stack__base__ca_cert_files:
  - src: "{{ docker_stack__internal_ssl_cert_dir }}/{{ docker_stack__ssl_internal_cert_file }}"
    dest: "{{ __docker_stack__traefik__dir }}/certs/{{ docker_stack__ssl_internal_cert_file }}"
  - src: "{{ docker_stack__internal_ssl_key_dir }}/{{ docker_stack__ssl_internal_privatekey_file }}"
    dest: "{{ __docker_stack__traefik__dir }}/certs/{{ docker_stack__ssl_internal_privatekey_file }}"
    mode: "0600"

#__docker_stack__traefik__image_default: "traefik:latest"
#__docker_stack__traefik__image_default: "traefik:v2.9.6"
#__docker_stack__traefik__image_default: "traefik:v2.10.1"
#__docker_stack__traefik__image_default: "traefik:v2.11.6"
## ref: https://doc.traefik.io/traefik/v3.0/migration/v2-to-v3/#docker-docker-swarm
#__docker_stack__traefik__image_default: "traefik:v3.1"
#__docker_stack__traefik__image_default: "traefik:v3.2"
#__docker_stack__traefik__image_default: "traefik:v3.6.1"
#__docker_stack__traefik__image_default: "traefik:v3.6.7"
__docker_stack__traefik__image_default: "traefik:v3.6"
__docker_stack__traefik__image: "{{ docker_stack__traefik__image | d(__docker_stack__traefik__image_default) }}"

#__docker_stack__base__socket_image: fluencelabs/docker-socket-proxy:latest
__docker_stack__base__socket_image: tecnativa/docker-socket-proxy:latest

######
## 'sts' tag resolves portainer image details/console access issue WRT docker v26.*
## ref: https://github.com/portainer/portainer/issues/11436
#__docker_stack__base__portainer_image: portainer/portainer-ce:latest
__docker_stack__base__portainer_image: portainer/portainer-ce:sts
__docker_stack__base__portainer_agent_image: portainer/agent:latest
__docker_stack__base__dozzle_image: amir20/dozzle:latest

#__docker_stack__base__watchtower_image: v2tec/watchtower
__docker_stack__base__watchtower_image: containrrr/watchtower:latest
__docker_stack__base__gc_image: clockworksoul/docker-gc-cron:latest

__docker_stack__traefik__auth_labels:
  ## Middlewares
  traefik.http.routers.traefik-rtr.middlewares: chain-oauth@file

__docker_stack__base__config_tpls:
  - src: traefik/config-traefik-{{ docker_stack__traefik__version }}.yml.j2
    dest: "{{ __docker_stack__traefik__dir }}/traefik.yml"
    backup: true
  - src: traefik/rules/middlewares.yml.j2
    dest: "{{ __docker_stack__traefik__dir }}/rules/middlewares.yml"
  - src: traefik/rules/middlewares-chains.yml.j2
    dest: "{{ __docker_stack__traefik__dir }}/rules/middlewares-chains.yml"
  - src: traefik/rules/certs-traefik.yml.j2
    dest: "{{ __docker_stack__traefik__dir }}/rules/certs-traefik.yml"
  - src: traefik/rules/tls-opts.yml.j2
    dest: "{{ __docker_stack__traefik__dir }}/rules/tls-opts.yml"
  - src: docker-gc-exclude.conf.j2
    dest: "{{ __docker_stack__base__stack_dir }}/docker-gc/docker-gc-exclude"

__docker_stack__base__config_dirs:
  - path: "{{ __docker_stack__base__stack_dir }}"
  - path: "{{ __docker_stack__traefik__dir }}"
  - path: "{{ __docker_stack__traefik__dir }}/rules"
  - path: "{{ __docker_stack__traefik__dir }}/certs"
  - path: "{{ __docker_stack__traefik__dir }}/acme"
  ## https://doc.traefik.io/traefik/v3.6/expose/swarm/advanced/#setup-multi-layer-routing-with-docker-swarm
  ## https://doc.traefik.io/traefik/v3.6/expose/swarm/advanced/#multi-layer-routing
  - path: "{{ __docker_stack__base__stack_dir }}/dynamic"
  - path: "{{ __docker_stack__base__stack_dir }}/shared"
  - path: "{{ __docker_stack__base__stack_dir }}/shared/certs"
  - path: "{{ __docker_stack__base__stack_dir }}/docker-gc"
  - path: "{{ __docker_stack__base__stack_dir }}/portainer"
  - path: "{{ __docker_stack__base__stack_dir }}/portainer/data"

################################
## NOTE: You need the following ports open to traffic to and from each Docker host participating on an overlay network:
## Reference:
##   https://www.digitalocean.com/community/tutorials/how-to-configure-the-linux-firewall-for-docker-swarm-on-centos-7
##   https://stackoverflow.com/questions/52665442/docker-swarm-host-cannot-resolve-hosts-on-other-nodes
__docker_stack__base__firewalld_ports:
  - 2376/tcp
  - 2377/tcp
  - 4789/udp
  - 7946/tcp
  - "{{ __docker_stack__traefik__http_port }}/tcp"
  - "{{ __docker_stack__traefik__https_port }}/tcp"

## ref: ## ref: https://www.virtualizationhowto.com/2023/03/docker-compose-static-ip-configuration/
## ref: https://docs.docker.com/engine/network/tutorials/overlay/
__docker_stack__traefik__proxy_network_config_swarm:
  external: true
  attachable: true
  scope: swarm
  ## make sure that the following segment does not overlap with the existing host network segment
  ipam_config:
    - subnet: "{{ docker_stack__network_subnet__traefik_proxy }}"

__docker_stack__traefik__proxy_network_config_standalone:
  external: true
  attachable: true
  scope: local
  ## make sure that the following segment does not overlap with the existing host network segment
  ipam_config:
    - subnet: "{{ docker_stack__network_subnet__traefik_proxy }}"

__docker_stack__traefik__proxy_network_config: |-
  {% set _docker_stack__traefik__proxy_network_config = {} %}
  {% if docker_stack__swarm_mode | d(false) %}
  {% set __ = _docker_stack__traefik__proxy_network_config.update(__docker_stack__traefik__proxy_network_config_swarm) %}
  {% else %}
  {% set __ = _docker_stack__traefik__proxy_network_config.update(__docker_stack__traefik__proxy_network_config_standalone) %}
  {% endif %}
  {{ _docker_stack__traefik__proxy_network_config }}
#  {{ _docker_stack__traefik__proxy_network_config | from_yaml }}

#docker_stack__traefik__proxy_network_info: "{{
#  { docker_stack__network_name__traefik_proxy: __docker_stack__traefik__proxy_network_config } }}"
##docker_stack__traefik__proxy_network_info: "{{ { docker_stack__network_name__traefik_proxy: { 'attachable': true } } }}"
##docker_stack__traefik__proxy_network_info: |
##  {{ {
##        docker_stack__network_name__traefik_proxy: {
##          'external': true
##        }
##      }
##  }}

## ref: ## ref: https://www.virtualizationhowto.com/2023/03/docker-compose-static-ip-configuration/
## ref: https://docs.docker.com/engine/network/tutorials/overlay/
## ref: https://github.com/stefanprodan/swarmprom/blob/master/docker-compose.traefik.yml
## ref: https://stackoverflow.com/questions/46845381/how-do-configure-docker-compose-to-use-a-given-subnet-if-a-variable-is-set-or-c
## ref: https://www.warp.dev/terminus/docker-compose-networks
## ref: https://stackoverflow.com/questions/50432734/what-is-the-purpose-of-the-ipam-key-in-a-docker-compose-config
__docker_stack__base__default_network_swarm:
#    name: net
  driver: overlay
  attachable: true
  ipam:
    config:
      - subnet: "{{ docker_stack__network_subnet__default }}"

#__docker_stack__base__default_network_standalone: {}
__docker_stack__base__default_network_standalone:
#    name: net
  attachable: true
  ipam:
    config:
      - subnet: "{{ docker_stack__network_subnet__default }}"

__docker_stack__base__default_network: |-
  {% set _docker_stack__base__default_network = {} %}
  {% if docker_stack__swarm_mode | d(false) %}
  {% set __ = _docker_stack__base__default_network.update(__docker_stack__base__default_network_swarm) %}
  {% else %}
  {% set __ = _docker_stack__base__default_network.update(__docker_stack__base__default_network_standalone) %}
  {% endif %}
  {{ _docker_stack__base__default_network }}
#  {{ _docker_stack__base__default_network | from_yaml }}

__docker_stack__traefik__environment_internal:
  PUID: "{{ docker_stack__user_uid }}"
  PGID: "{{ docker_stack__user_gid }}"
  TZ: "{{ docker_stack__timezone }}"

__docker_stack__traefik__environment_external:
  CLOUDFLARE_EMAIL: "{{ docker_stack__cloudflare_email }}"
  CLOUDFLARE_API_KEY: "{{ docker_stack__cloudflare_apikey }}"
  CF_API_EMAIL: "{{ docker_stack__cloudflare_email }}"
  CF_API_KEY: "{{ docker_stack__cloudflare_apikey }}"

__docker_stack__traefik__environment: |-
  {% set _traefik_environment = {} %}
  {% set _ = _traefik_environment.update(__docker_stack__traefik__environment_internal) %}
  {% if docker_stack__enable_external_route %}
  {% set _ = _traefik_environment.update(__docker_stack__traefik__environment_external) %}
  {% endif %}
  {{ _traefik_environment }}
#  {{ _traefik_environment | from_yaml }}

## ref: https://www.virtualizationhowto.com/2023/03/docker-compose-static-ip-configuration/
## ref: https://docs.docker.com/engine/network/tutorials/overlay/
__docker_stack__base__networks_socket_base_proxy:
  attachable: true
  name: "{{ docker_stack__network_name__socket_proxy }}"
  ipam:
    config:
      - subnet: "{{ docker_stack__network_subnet__socket_proxy }}"
#        gateway: 192.168.11.1
##  driver: bridge
##  external: true
##  ipam_config:
##    - subnet: 10.0.3.0/24

__docker_stack__base__networks_socket_swarm_proxy:
  driver: overlay

__docker_stack__base__networks_socket_proxy: >-
  {{
    __docker_stack__base__networks_socket_base_proxy
    | combine(__docker_stack__base__networks_socket_swarm_proxy if docker_stack__swarm_mode | bool else {})
  }}


## ref: https://docs.ansible.com/ansible/latest/collections/community/docker/docker_network_module.html noqa: yaml[line-length]
#__docker_stack__base__networks_default:
#  default: "{{ __docker_stack__base__default_network }}"
#  socket_proxy: "{{ __docker_stack__base__networks_socket_proxy }}"

__docker_stack__base__networks_default: "{{
    {docker_stack__network_name__default: __docker_stack__base__default_network,
    docker_stack__network_name__socket_proxy: __docker_stack__base__networks_socket_proxy,
    docker_stack__network_name__traefik_proxy: __docker_stack__traefik__proxy_network_config} }}"

#__docker_stack__traefik__networks: "{{ __docker_stack__base__networks_default
#  | combine( { docker_stack_proxy_network: { 'external': true } } ) }}"
#__docker_stack__base__networks: "{{ (docker_stack__base_networks | d(__docker_stack__base__networks_default))
#  | combine(docker_stack__traefik__proxy_network_info) }}"
__docker_stack__base__networks: "{{ docker_stack__base_networks | d(__docker_stack__base__networks_default) }}"

__docker_stack__base__volumes: {}

docker_stack__appspec__base:
  dirs: "{{ __docker_stack__base__config_dirs | d([]) }}"
  files: "{{ __docker_stack__base__config_files | d([]) }}"
  templates: "{{ __docker_stack__base__config_tpls | d([]) }}"
  firewalld_services: "{{ __docker_stack__base__firewalld_services | d([]) }}"
  firewalld_ports: "{{ __docker_stack__base__firewalld_ports | d([]) }}"
  networks: "{{ __docker_stack__base__networks | d({}) }}"
  volumes: "{{ __docker_stack__base__volumes | d({}) }}"
  docker_services: "{{ __docker_stack__base__services | d({}) }}"

__docker_stack__traefik__labels: "{{ docker_stack__traefik__labels
  | d(__docker_stack__traefik__labels_default) }}"
__docker_stack__whoami__traefik_labels: "{{ docker_stack__whoami__traefik_labels
  | d(__docker_stack__whoami__traefik_labels_default) }}"
__docker_stack__portainer__traefik_labels: "{{ docker_stack__portainer__traefik_labels
  | d(__docker_stack__portainer__traefik_labels_default) }}"
__docker_stack__dozzle__traefik_labels: "{{ docker_stack__dozzle__traefik_labels
  | d(__docker_stack__dozzle__traefik_labels_default) }}"

__docker_stack__dozzle__environment: "{{ docker_stack__dozzle__environment
  | d(__docker_stack__dozzle__environment_default) }}"

__docker_stack__socket_proxy_mode: "{{ '1' if docker_stack__swarm_mode | d(false) else '0' }}"

## ref: https://github.com/htpcBeginner/docker-traefik/blob/master/docker-compose-t2.yml
__docker_stack__base__services_internal:
  ######### FRONTENDS ##########
  # Traefik Reverse Proxy
  # ref: https://github.com/lj020326/docker_swarm-mode.traefik2-example/blob/master/docker-compose.app.v10.yml
  # ref: https://doc.traefik.io/traefik/v3.6/setup/swarm/
  traefik:
    container_name: traefik
    #    hostname: traefik
    image: "{{ __docker_stack__traefik__image }}"
    restart: unless-stopped
    depends_on:
      - socket-proxy
    networks:
      - "{{ docker_stack__network_name__traefik_proxy }}"
      - "{{ docker_stack__network_name__socket_proxy }}"
    #    security_opt:
    #      - no-new-privileges=true
    #healthcheck:
    #  test: ["CMD", "traefik", "healthcheck", "--ping"]
    #  interval: 5s
    #  retries: 3
    ports:
      - target: 80
        published: "{{ __docker_stack__traefik__http_port | int }}"
        protocol: tcp
        mode: "{{ __docker_stack__port_mode }}"
      - target: 443
        published: "{{ __docker_stack__traefik__https_port | int }}"
        protocol: tcp
        mode: "{{ __docker_stack__port_mode }}"
    # - target: 8080
    #   published: 8080
    #   protocol: tcp
    #   mode: "{{ __docker_stack__port_mode }}"
    #- target: 8081
    #  published: 8082
    #  protocol: tcp
    #  mode: "{{ __docker_stack__port_mode }}"
    environment: "{{ __docker_stack__traefik__environment }}"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "{{ __docker_stack__traefik__dir }}:/etc/traefik"
      - "{{ __docker_stack__traefik__dir }}/certs:/certs"
      ## https://doc.traefik.io/traefik/v3.6/expose/swarm/advanced/#multi-layer-routing
      - "{{ __docker_stack__base__stack_dir }}/dynamic:/dynamic"
      - "{{ __docker_stack__base__stack_dir }}/shared:/shared"
    deploy:
      ## References:
      ## https://docs.docker.com/engine/swarm/networking/#configure-service-discovery
      ## https://stackoverflow.com/questions/52665442/docker-swarm-host-cannot-resolve-hosts-on-other-nodes
      ## https://docs.docker.com/engine/swarm/ingress/#without-the-routing-mesh
      ## https://docs.docker.com/compose/compose-file/compose-file-v3/#endpoint_mode
#      endpoint_mode: dnsrr
#      endpoint_mode: vip
#      mode: replicated
#      mode: global
      placement:
        constraints:
          - node.labels.traefik-public.traefik-enabled == true
#          - node.role == manager
#          - node.hostname == {{ __docker_stack__traefik__node }}
##          - node.labels.proxy == true
##          - node.labels.traefik-public == true
##      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 3
        window: 60s
      update_config:
        order: start-first
#        order: stop-first
    labels: "{{ __docker_stack__traefik__labels }}"

  # Docker Socket Proxy - Security Enchanced Proxy for Docker Socket
  socket-proxy:
    hostname: socket-proxy
    container_name: socket-proxy
    #    hostname: socket-proxy
    image: "{{ __docker_stack__base__socket_image }}"
    restart: always
    networks:
      - "{{ docker_stack__network_name__socket_proxy }}"
    #      - "{{ docker_stack__network_name__traefik_proxy }}"
    privileged: true
    ports:
#      - 2375:2375
      - target: 2375
        published: 2375
        protocol: tcp
#        mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      LOG_LEVEL: debug # debug,info,notice,warning,err,crit,alert,emerg
      ## Variables match the URL prefix (i.e. AUTH blocks access to /auth/* parts of the API, etc.).
      # 0 to revoke access.
      # 1 to grant access.
      ## Granted by Default
      EVENTS: 1
      PING: 1
      VERSION: 1
      ## Revoked by Default
      # Security critical
      AUTH: 0
      SECRETS: 0
      POST: 1 # Watchtower
      DELETE: 1 # Watchtower
      # GET Optons
      BUILD: 0
      COMMIT: 0
      CONFIGS: 0
      CONTAINERS: 1 # Traefik, portainer, etc.
      DISTRIBUTION: 0
      EXEC: 0
      IMAGES: 1 # Portainer, Watchtower
      INFO: 1 # Portainer
      NETWORKS: 1 # Portainer, Watchtower
      NODES: 1
      PLUGINS: 0
      SERVICES: 1 # Portainer
      SESSION: 0
      SWARM: "{{ __docker_stack__socket_proxy_mode | int }}"
      SYSTEM: 0
      TASKS: 1 # Portainer
      VOLUMES: 1 # Portainer
      # POST Options
      CONTAINERS_CREATE: 1 # WatchTower
      CONTAINERS_START: 1 # WatchTower
      CONTAINERS_UPDATE: 1 # WatchTower
      # DELETE Options
      CONTAINERS_DELETE: 1 # WatchTower
      IMAGES_DELETE: 1 # WatchTower
    deploy:
#      endpoint_mode: dnsrr
#      mode: global
      mode: replicated
      placement:
        constraints:
          - node.labels.traefik-public.traefik-enabled == true
#          - node.role == manager
#          - node.hostname == {{ __docker_stack__traefik__node }}
#          - node.hostname == {{ inventory_hostname }}
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        order: stop-first

  ## Whoami - useful for debugging traefik config related issues
  ## ref: https://doc.traefik.io/traefik/v3.6/setup/swarm/
  ## ref: https://doc.traefik.io/traefik/v3.6/expose/swarm/advanced/
  ## use curl based testing to test specific swarm endpoints:
  #  root@admin01:[docker]$ curl --resolve whoami.admin01.dettonville.int:443:10.0.7.20 https://whoami.admin01.dettonville.int
  #  Hostname: 3455e0edc73a
  #  IP: 127.0.0.1
  #  IP: ::1
  #  IP: 172.16.1.93
  #  IP: 172.19.0.5
  #  IP: 172.20.12.10
  #  RemoteAddr: 172.20.12.6:57998
  #  GET / HTTP/1.1
  #  Host: whoami.admin01.dettonville.int
  #  User-Agent: curl/8.5.0
  #  Accept: */*
  #  Accept-Encoding: gzip
  #  X-Forwarded-For: 172.19.0.1
  #  X-Forwarded-Host: whoami.admin01.dettonville.int
  #  X-Forwarded-Port: 443
  #  X-Forwarded-Proto: https
  #  X-Forwarded-Server: 85b516941465
  #  X-Real-Ip: 172.19.0.1
  whoami:
    image: containous/whoami
    container_name: whoami
    #    hostname: "whoami"
    networks:
      - "{{ docker_stack__network_name__traefik_proxy }}"
    ports:
      - target: 80
        published: 9080
        protocol: tcp
    #        mode: "{{ __docker_stack__port_mode }}"
    #      - 9080:80/tcp
    deploy:
      mode: global
      #      placement:
      #        constraints:
      #        - node.role==manager
      #        - node.role!=manager
      #      mode: replicated
      #      replicas: 5
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
    labels: "{{ __docker_stack__whoami__traefik_labels }}"

  ######### DOCKER RELATED ##########
  # Watchtower - Automatic Update of Containers/Apps
  watchtower:
    image: "{{ __docker_stack__base__watchtower_image }}"
    container_name: watchtower
    restart: unless-stopped
    networks:
      - "{{ docker_stack__network_name__default }}"
      - "{{ docker_stack__network_name__socket_proxy }}"
    depends_on:
      - socket-proxy
    #    volumes:
    #      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      TZ: "{{ docker_stack__timezone }}"
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_REMOVE_VOLUMES: "true"
      WATCHTOWER_INCLUDE_STOPPED: "true"
      WATCHTOWER_NO_STARTUP_MESSAGE: "false"
      WATCHTOWER_SCHEDULE: 0 30 12 * * * # Everyday at 12:30
      #      WATCHTOWER_NOTIFICATIONS: shoutrrr
      WATCHTOWER_NOTIFICATIONS_LEVEL: info
      #      WATCHTOWER_NOTIFICATION_URL: "telegram://{{ __docker_stack__base__tgram_bot_token }}@telegram?channels={{ __docker_stack__base__tgram_chat_id }}"
      DOCKER_HOST: tcp://socket-proxy:2375
    #      DOCKER_API_VERSION: "1.40"
    deploy:
      endpoint_mode: dnsrr
#      mode: global
      mode: replicated
      placement:
        constraints:
          - node.labels.traefik-public.traefik-enabled == true
#          - node.role == manager
#          - node.hostname == {{ __docker_stack__traefik__node }}
      replicas: 1
  #      restart_policy:
  #        condition: on-failure
  #        delay: 10s
  #        max_attempts: 3
  #        window: 120s

  # Docker-GC - Automatic Docker Garbage Collection
  # Create docker-gc-exclude file
  dockergc:
    image: "{{ __docker_stack__base__gc_image }}"
    container_name: docker-gc
    restart: unless-stopped
    networks:
      - "{{ docker_stack__network_name__socket_proxy }}"
    depends_on:
      - socket-proxy
    volumes:
      # - /var/run/docker.sock:/var/run/docker.sock # Use Docker Socket Proxy instead for improved security
      ## https://github.com/clockworksoul/docker-gc-cron
      - "{{ __docker_stack__base__stack_dir }}/docker-gc/docker-gc-exclude:/etc/docker-gc-exclude"
    environment:
      CRON: 0 0 0 * * ? # Everyday at midnight. Previously 0 0 * * *
      FORCE_IMAGE_REMOVAL: 1
      FORCE_CONTAINER_REMOVAL: 0
      GRACE_PERIOD_SECONDS: 604800
      DRY_RUN: 0
      CLEAN_UP_VOLUMES: 1
      TZ: "{{ docker_stack__timezone }}"
      DOCKER_HOST: tcp://socket-proxy:2375
    deploy:
      mode: global
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s

  ## ref: https://blog.antosubash.com/posts/setup-traefik-docker
  ## ref: https://stackoverflow.com/questions/64735377/deploy-portainer-portainer-agent-using-docker-compose
  portainer-agent:
    image: "{{ __docker_stack__base__portainer_agent_image }}"
    container_name: portainer-agent
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
    networks:
      - "{{ docker_stack__network_name__socket_proxy }}"
    #    ports:
    #      - target: 9001
    #        published: 9001
    #        protocol: tcp
    #        mode: "{{ __docker_stack__port_mode }}"
    deploy:
#      mode: global
      mode: replicated
      placement:
        constraints:
          - node.labels.traefik-public.traefik-enabled == true
#          - node.role == manager
#          - node.hostname == {{ __docker_stack__traefik__node }}
#          - node.hostname == {{ inventory_hostname }}
      replicas: 1
#      labels:
#        - "traefik.enable=false"

  # Portainer - WebUI for Containers
  ## ref: https://sleeplessbeastie.eu/2020/10/21/how-to-deploy-portainer-stack-inside-docker-swarm-cluster/
  portainer:
    image: "{{ __docker_stack__base__portainer_image }}"
    container_name: portainer
    restart: unless-stopped
    #    command: -H unix:///var/run/docker.sock # # Use Docker Socket Proxy instead for improved security
    #    command: -H tcp://socket-proxy:2375 # appears to not work. Workaround was to create a new socket-proxy:2375 endpoint on portainer settings
    command: -H tcp://tasks.portainer-agent:9001 --tlsskipverify
    environment:
      TZ: "{{ docker_stack__timezone }}"
    networks:
      - "{{ docker_stack__network_name__traefik_proxy }}"
      - "{{ docker_stack__network_name__socket_proxy }}"
    #    depends_on:
    #      - socket-proxy
    ##      - portainer-agent
    ports:
      - target: 9000
        published: 9010
        protocol: tcp
#        mode: "{{ __docker_stack__port_mode }}"
    #      - 9010:9000/tcp
    security_opt:
      - no-new-privileges=true
    volumes:
      - /etc/localtime:/etc/localtime
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
      - "{{ __docker_stack__base__stack_dir }}/portainer/data:/data"
    deploy:
      mode: replicated
      placement:
        constraints:
          - node.labels.traefik-public.traefik-enabled == true
#          - node.role == manager
#          - node.hostname == {{ __docker_stack__traefik__node }}
#          - node.hostname == {{ inventory_hostname }}
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        order: stop-first
    labels: "{{ __docker_stack__portainer__traefik_labels }}"

  # Dozzle - Real-time Docker Log Viewer
  dozzle:
    image: "{{ __docker_stack__base__dozzle_image }}"
    container_name: dozzle
    restart: unless-stopped
    networks:
      - "{{ docker_stack__network_name__traefik_proxy }}"
#      - "{{ docker_stack__network_name__socket_proxy }}"
    #    depends_on:
    #      - socket-proxy
    security_opt:
      - no-new-privileges=true
    environment: "{{ __docker_stack__dozzle__environment }}"
    ports:
      - target: 8080
        published: 8080
        protocol: tcp
#        mode: "{{ __docker_stack__port_mode }}"
    volumes:
      # Use Docker Socket Proxy instead for improved security
      # Socket-proxy cannot be used in Docker Swarm mode
      # ref: https://dozzle.dev/guide/swarm-mode
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
#      mode: global
      mode: replicated
      placement:
        constraints:
          - node.labels.traefik-public.traefik-enabled == true
#          - node.role == manager
#          - node.hostname == {{ __docker_stack__traefik__node }}
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s
    labels: "{{ __docker_stack__dozzle__traefik_labels }}"

__docker_stack__base__services_external:
  # Traefik Certs Dumper - Extract LetsEncrypt Certificates - Traefik2 Compatible
  certdumper:
    container_name: traefik_certdumper
    image: humenius/traefik-certs-dumper:latest
    #    network_mode: none
    networks:
      - "{{ docker_stack__network_name__default }}"
    security_opt:
      - no-new-privileges=true
    # command: --restart-containers container1,container2,container3
    user: "{{ docker_stack__user_uid }}:{{ docker_stack__user_gid }}"
    environment:
      DOMAIN: "{{ docker_stack__external_domain }}"
    volumes:
      - "{{ __docker_stack__traefik__dir }}/acme:/traefik:ro"
      - "{{ __docker_stack__base__cert_dump_dir }}:/output:rw"
      # - /var/run/docker.sock:/var/run/docker.sock:ro # Only needed if restarting containers (use Docker Socket Proxy instead)
    deploy:
      placement:
        constraints:
          - node.labels.traefik-public.traefik-enabled == true
#          - node.role == manager
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s

__docker_stack__base__services: |-
  {% set _base_docker_services = {} %}
  {% set _ = _base_docker_services.update(__docker_stack__base__services_internal) %}
  {% if docker_stack__enable_external_route %}
  {% set _ = _base_docker_services.update(__docker_stack__base__services_external) %}
  {% endif %}
  {{ _base_docker_services }}
#  {{ _base_docker_services | from_yaml }}

#__docker_stack__base__services: |-
#  {% set _base_docker_services = {} %}
#  {% set _ = _base_docker_services.update(__docker_stack__base__services_internal) %}
#  {{ _base_docker_services | from_yaml }}
