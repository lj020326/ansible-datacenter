---

# Gather Ansible Facts About Host #
- name: Gather Ansible Facts About Host
  setup:
    gather_subset:
      - all
- debug:
    msg: "{{ ansible_facts }}"

# Set Reportable Facts #
- name: Set Reportable Windows Host Facts
  set_fact:
    nodename: "{{ ansible_facts['nodename'] }}"
    domain: "{{ ansible_facts['domain'] }}"
    windows_domain_member: "{{ ansible_facts['windows_domain_member'] }}"
    windows_domain_role: "{{ ansible_facts['windows_domain_role'] }}"
    distribution: "{{ ansible_facts['distribution'] }}"
    distribution_major_version: "{{ ansible_facts['distribution_major_version'] }}"
    distribution_version: "{{ ansible_facts['distribution_version'] }}"
    architecture: "{{ ansible_facts['architecture'] }}"
    bios_date: "{{ ansible_facts['bios_date'] }}"
    bios_version: "{{ ansible_facts['bios_version'] }}"
    connection_name: "{{ ansible_facts | json_query('interfaces[*].connection_name') }}"
    interface_name: "{{ ansible_facts | json_query('interfaces[*].interface_name') }}"
    ipv4_address: "{{ ansible_facts | json_query('ip_addresses[0]') }}"
    ipv6_address: "{{ ansible_facts | json_query('ip_addresses[1]') }}"
    default_gateway: "{{ ansible_facts | json_query('interfaces[*].default_gateway') }}"
    mac_address: "{{ ansible_facts | json_query('interfaces[*].macaddress') }}"
    lastboot: "{{ ansible_facts['lastboot'] }}"
    reboot_pending: "{{ ansible_facts['reboot_pending'] }}"
    uptime: "{{ ansible_facts['uptime_seconds'] }}"
    machine_id: "{{ ansible_facts['machine_id'] }}"
    total_memory: "{{ ansible_facts['memtotal_mb'] }}"
    processor: "{{ ansible_facts | json_query('processor[1]') }}"
    processor_cores: "{{ ansible_facts['processor_cores'] }}"
    processor_count: "{{ ansible_facts['processor_count']}}"
    product_name: "{{ ansible_facts['product_name'] }}"

#- name: Run PowerShell script with parameters
#  win_shell: |
#      (Get-WmiObject win32_volume | Select-Object SystemName,Name, BlockSize, Capacity, FreeSpace, DriveLetter , @{Name="CapacityGB";Expression={[math]::round($_.Capacity/1GB,2)}}, @{Name="FreeSpaceGB";Expression={[math]::round($_.FreeSpace/1GB,2)}} , @{Name="FreeSpacePercent";Expression={[math]::round(($_.FreeSpace/($_.Capacity*1.00))*100.00,2)}} , @{Name="Date";Expression={$(Get-Date -f s)}}| Sort-Object Name | Convertto-JSON -Compress).Replace('\\"','"')
#  register: output
#- debug:
#    var: output
#- debug:
#    msg: "{{ (item.CapacityGB|round|int }} GiB is the P drive and the Memory is {{ ansible_facts.ansible_memory_mb.real.total}} MB for server {{ansible_hostname}}"

- name: "Update inventory report repo"
  delegate_to: "localhost"
  become: no
  run_once: yes
  block:

    - name: Update inventory reports repo
      include_tasks: update-reports-repo.yml
