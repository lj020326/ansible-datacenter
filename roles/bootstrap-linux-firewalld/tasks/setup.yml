---

- set_fact:
    __log_prefix_local: "Firewalld | Setup |"

- name: "{{ __log_prefix_local }} Display firewalld_packages"
  debug:
    var: firewalld_packages

- name: "{{ __log_prefix_local }} Install firewalld and firewalld-python packages"
  package:
    name: "{{ firewalld_packages }}"
    state: present

- name: "{{ __log_prefix_local }} Install firewalld"
  package:
    name: firewalld
    state: present

- name: "{{ __log_prefix_local }} Enable firewalld"
  service:
    name: firewalld
    state: started
    enabled: yes

- name: "{{ __log_prefix_local }} Initialize firewalld zones"
  template:
    src: firewalld.conf.j2
    dest: "{{ firewalld_conf_file }}"
    backup: yes
  with_items: "{{ firewalld_zones }}"
  notify: reload firewalld
  loop_control:
    label: "{{ item.name }}"

- name: "{{ __log_prefix_local }} Customize firewalld.conf according to any firewalld_configs settings"
  ini_file:
    path: "{{ firewalld_conf_file }}"
    no_extra_spaces: yes
    section: ''
    option: "{{ item.key }}"
    value: "{{ item.value }}"
  with_dict: "{{ firewalld_configs }}"
  notify: reload firewalld

#- name: "{{ __log_prefix_local }} Configure firewalld custom services"
#  when: item.custom|d(false)
#  template:
#    src: service_template.xml.j2
#    dest: /etc/firewalld/services/{{ item.name }}.xml
#    backup: yes
#  with_items: "{{ firewalld_services }}"
#  notify: reload firewalld
#  loop_control:
#    label: "{{ item.name }}"
#
#- name: "{{ __log_prefix_local }} reload firewalld"
#  command: firewall-cmd --reload
#
#- name: "{{ __log_prefix_local }} "Display firewalld_zones""
#  debug:
#    var: firewalld_zones
#
#- name: "{{ __log_prefix_local }} Configure firewalld zones"
#  template:
#    src: zone_template.xml.j2
#    dest: /etc/firewalld/zones/{{ item.name }}.xml
#    backup: yes
#  with_items: "{{ firewalld_zones }}"
#  notify: reload firewalld
#  loop_control:
#    label: "{{ item.name }}"
#  register: firewalld_zone_backup
#
##- name: "{{ __log_prefix_local }} Display firewalld_zone_backup"
##  debug:
##    var: firewalld_zone_backup
##
#### ref: https://github.com/ansible/ansible/issues/16305#issuecomment-475220643
##- name: "{{ __log_prefix_local }} "Move original {{ firewalld_zone_backup.backup }} zone file backup to backup directory {{ firewalld_backup_dir }}/zones""
##  shell: >
##    mkdir --parents {{ firewalld_backup_dir }}/zones &&
##    mv {{ firewalld_zone_backup.backup }} {{ firewalld_backup_dir }}/zones/{{ firewalld_zone_backup.backup }}
##  when: firewalld_zone_backup.backup
#
#- name: "{{ __log_prefix_local }} Get zones in /etc/firewalld/zones"
#  shell: ls -1 /etc/firewalld/zones/ | grep -E .xml$
#  register: get_firewalld_zones
#  changed_when: false
#  failed_when: false
#
#- name: "{{ __log_prefix_local }} Remove unmanaged zones in /etc/firewalld/zones"
#  file:
#    path: "/etc/firewalld/zones/{{ item }}"
#    state: absent
#  with_items: "{{ get_firewalld_zones.stdout_lines }}"
#  notify: reload firewalld
#  when: item|replace('.xml','') not in firewalld_zones|map(attribute='name')|list
#
#- name: "{{ __log_prefix_local }} "Display firewalld_ipsets""
#  debug:
#    var: firewalld_ipsets
#
#- name: "{{ __log_prefix_local }} Configure firewalld ipsets"
#  template:
#    src: ipset_template.xml.j2
#    dest: /etc/firewalld/ipsets/{{ item.name }}.xml
#    backup: yes
#  with_items: "{{ firewalld_ipsets }}"
#  notify: reload firewalld
#  loop_control:
#    label: "{{ item.name }}"
#
#- name: "{{ __log_prefix_local }} Get ipsets in /etc/firewalld/ipsets"
#  shell: ls -1 /etc/firewalld/ipsets/ | grep -E .xml$
#  register: get_firewalld_ipsets
#  changed_when: false
#  failed_when: false
#
#- name: "{{ __log_prefix_local }} Remove unmanaged ipsets in /etc/firewalld/ipsets"
#  file:
#    path: "/etc/firewalld/ipsets/{{ item }}"
#    state: absent
#  with_items: "{{ get_firewalld_ipsets.stdout_lines }}"
#  notify: reload firewalld
#  when: item|replace('.xml','') not in firewalld_ipsets|map(attribute='name')|list

#- name: "{{ __log_prefix_local }} Restart firewalld"
#  service:
#    name: firewalld
#    state: restarted

