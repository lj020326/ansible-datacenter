---
- name: Package | APT - Check that HTTPS Transport is Installed
  when:
    - bootstrap_linux_package__apt_repo_use_https | bool
  ansible.builtin.apt:
    name: apt-transport-https
    state: present

- name: Package | APT - Install repositories
  when: ansible_facts['distribution_major_version'] | int <= 11
  block:

    - name: Package | APT - Display bootstrap_linux_package__apt_sources
      ansible.builtin.debug:
        var: bootstrap_linux_package__apt_sources

    - name: Package | APT - Install sources.list
      when:
        - bootstrap_linux_package__apt_sources | bool
      ansible.builtin.template:
        src: "{{ bootstrap_linux_package__apt_sources_tpl }}"
        dest: "{{ bootstrap_linux_package__apt_sources_file }}"
        owner: root
        group: root
        mode: "0644"
        backup: true
      notify: APT Update Cache

    - name: Package | APT - Display bootstrap_linux_package__apt_backports
      ansible.builtin.debug:
        var: bootstrap_linux_package__apt_backports

    - name: Package | APT - Install backports.list
      when:
        - bootstrap_linux_package__apt_backports | bool
        - ansible_facts['distribution'] == 'Debian'
      ansible.builtin.template:
        src: "{{ bootstrap_linux_package__apt_backports_tpl }}"
        dest: "{{ bootstrap_linux_package__apt_backports_file }}"
        owner: root
        group: root
        mode: "0644"
        backup: true
      notify: APT Update Cache

    - name: Package | APT - Display bootstrap_linux_package__apt_experimental
      ansible.builtin.debug:
        var: bootstrap_linux_package__apt_experimental

    - name: Package | APT - Install experimental.list
      when:
        - bootstrap_linux_package__apt_experimental | bool
        - ansible_facts['distribution'] == 'Debian'
      ansible.builtin.template:
        src: "{{ bootstrap_linux_package__apt_experimental_tpl }}"
        dest: "{{ bootstrap_linux_package__apt_experimental_file }}"
        owner: root
        group: root
        mode: "0644"
        backup: true
      notify: APT Update Cache

- name: Package | APT - Custom repos
  when: bootstrap_linux_package__custom_repo_list.apt | length > 0
  block:
    - name: Package | APT - Install Custom repo key
      ansible.builtin.apt_key:
        url: "{{ item.key_url }}"
        state: "{{ item.state | d(package__state) }}"
      loop: "{{ bootstrap_linux_package__custom_repo_list.apt }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Package | APT - Install Custom repo
      ansible.builtin.apt_repository:
        repo: "{{ item.repo_url }}"
        state: "{{ item.state | d(package__state) }}"
        filename: "{{ item.filename | d(item.name) | lower }}"
        update_cache: "{{ package__update_cache }}"
      loop: "{{ bootstrap_linux_package__custom_repo_list.apt }}"
      loop_control:
        label: "{{ item.name }}"

- name: Package | APT - Update System Package Cache
  ansible.builtin.apt:
    update_cache: true
    force_apt_get: true
#    cache_valid_time: 3600

- name: Package | APT - Run Handlers
  ansible.builtin.meta: flush_handlers
