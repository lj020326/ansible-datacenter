---
# Post-deployment validation tasks

- name: "validate-pki-certs : Deploy validation script"
  ansible.builtin.template:
    src: validate_certs.sh.j2
    dest: "{{ deploy_pki_certs__local_cert_dir }}/validate_certs.sh"
    mode: '0755'  # Executable
    backup: false
  changed_when: true

- name: "validate-pki-certs : Set quiet flag"
  when: ansible_verbosity < 1
  ansible.builtin.set_fact:
    _quiet_flag: "--quiet"

- name: "validate-pki-certs : Run validation script"
  environment:
    PATH: "{{ ansible_facts.env.PATH }}:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    TERM: "dumb"
  ansible.builtin.shell:
    cmd: >-
      {{ deploy_pki_certs__local_cert_dir }}/validate_certs.sh
      {{ deploy_pki_certs__validation_args | default('') | trim | split(' ') | join(' ') }}
      {{ _quiet_flag | d('') }}
    executable: /bin/bash  # Ensure bash for script
  register: __cert_validation_output
  changed_when: false  # Validation is read-only
  failed_when: __cert_validation_output.rc != 0
  # Optional: Don't halt playbook
  ignore_errors: "{{ deploy_pki_certs__validation_fail_fast | default(false) | bool }}"

- name: "validate-pki-certs : Display validation output"
  ansible.builtin.debug:
    var: __cert_validation_output
    verbosity: 1

- name: "validate-pki-certs : Display validation output"
  when: >-
    __cert_validation_output.stdout | d('') | length > 0
    or __cert_validation_output.stderr | d('') | length > 0
  ansible.builtin.debug:
    msg: |
      STDOUT: {{ __cert_validation_output.stdout }}
      STDERR: {{ __cert_validation_output.stderr | default('None') }}
      RC: {{ __cert_validation_output.rc }}

- name: "validate-pki-certs : Deploy Python SSL validation script"
  ansible.builtin.template:
    src: "verify_ssl_connection.py.j2"
    dest: "/usr/local/bin/verify_ssl_connection.py"
    mode: '0755'

- name: "validate-pki-certs : Run Python SSL validation script"
  ansible.builtin.command:
    cmd: "python3 /usr/local/bin/verify_ssl_connection.py"
  register: __ssl_validation_result
  failed_when: __ssl_validation_result.rc != 0
  changed_when: false

- name: "validate-pki-certs : Display validation script output"
  ansible.builtin.debug:
    msg: "{{ __ssl_validation_result.stdout_lines + __ssl_validation_result.stderr_lines }}"

- name: "validate-pki-certs : Summary => Certificate deployment changes"
  when: __ssl_validation_result is defined
  ansible.builtin.debug:
    msg: "CA cert changed: {{ __ca_cert_has_changed | d('N/A') }} | Validation: {{ __ssl_validation_result.rc == 0 }}"
