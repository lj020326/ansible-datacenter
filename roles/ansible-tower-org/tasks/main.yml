---

- name: Display tower organizations config
  debug:
    msg: "tower_organizations={{ tower_organizations | to_nice_yaml }}"

- name: Create organizations
  tower_organization:
    name: "{{ item.name }}"
    description: "{{ item.description | d(omit) }}"
    galaxy_credentials: "{{ galaxy_credentials | d(omit) }}"
    state: "{{ item.state | d(omit) }}"
  loop: "{{ tower_organizations }}"

- name: Flatten the list of credentials
  set_fact:
    tower_credential_list: "{{ _credential_list|from_yaml }}"
  vars:
    _credential_list: |-
      {% for i in tower_organizations %}
      {% if "credentials" in i %}
      {% for j in i.credentials %}
      - {{ { 'organization': i.name } | combine(j) }}
      {% endfor %}
      {% endif %}
      {% endfor %}

- name: Display tower_credential_list
  debug:
    var: tower_credential_list

#- name: Create credentials
#  tower_credential: "{{ item }}"
#  loop: "{{ tower_credential_list }}"
##    name: "{{ item.1.name }}"
##    organization: "{{ item.0.name }}"
##    team: "{{ item.1.team | d(omit) }}"
##    description: "{{ item.1.description | d(omit) }}"
##    credential_type: "{{ item.1.credential_type | d(omit) }}"
##    inputs: "{{ item.1.inputs | d(omit) }}"
##    controller_username: "{{ item.1.controller_username | d(omit) }}"
##    controller_password: "{{ item.1.controller_password | d(omit) }}"
##    controller_host: "{{ item.1.controller_host | d(omit) }}"
##    controller_config_file: "{{ item.1.controller_config_file | d(omit) }}"
##    controller_oauthtoken: "{{ item.1.controller_oauthtoken | d(omit) }}"
##    vault_password: "{{ item.1.vault_password | d(omit) }}"
##    state: "{{ item.1.state | d(omit) }}"
##  loop: "{{ tower_organizations | subelements('credentials', { 'skip_missing': true }) }}"
##  loop_control:
##    label: "org:[{{ item.0.name }}] => inventory:[{{ item.1.name }}]"


- name: Create inventories
  tower_inventory:
    name: "{{ item.1.name }}"
    organization: "{{ item.0.name }}"
    description: "{{ item.1.description | d(omit) }}"
    host_filter: "{{ item.1.host_filter | d(omit) }}"
    instance_groups: "{{ item.1.instance_groups | d(omit) }}"
    state: "{{ item.1.state | d(omit) }}"
  loop: "{{ tower_organizations | subelements('inventories', { 'skip_missing': true }) }}"
  loop_control:
    label: "org:[{{ item.0.name }}] => inventory:[{{ item.1.name }}]"

- name: Create projects
  tower_project:
    name: "{{ item.1.name }}"
    organization: "{{ item.0.name }}"
    description: "{{ item.1.description | d(omit) }}"
    scm_type: "{{ item.1.scm_type | d(omit) }}"
    scm_url: "{{ item.1.scm_url | d(omit) }}"
    scm_branch: "{{ item.1.scm_branch | d(omit) }}"
    state: "{{ item.1.state | d('present') }}"
  loop: "{{ tower_organizations | subelements('projects', { 'skip_missing': true }) }}"
  loop_control:
    label: "org:[{{ item.0.name }}] => project:[{{ item.1.name }}]"

- name: Create teams
  tower_team:
    name: "{{ item.1.name }}"
    organization: "{{ item.0.name }}"
    description: "{{ item.1.description | d(omit) }}"
    state: "{{ item.1.state | d(omit) }}"
  loop: "{{ tower_organizations | subelements('teams', { 'skip_missing': true }) }}"
  loop_control:
    label: "org:[{{ item.0.name }}] => team:[{{ item.1.name }}]"

- name: Flatten the list of templates
  set_fact:
    tower_template_list: "{{ _template_list|from_yaml }}"
  vars:
    _template_list: |-
      {% for i in tower_organizations %}
      {% if "projects" in i %}
      {% for j in i.projects %}
      {% if "job_templates" in j %}
      {% for k in j.job_templates %}
      - {{ { 'organization': i.name, 'project': j.name } | combine(k) }}
      {% endfor %}
      {% endif %}
      {% endfor %}
      {% endif %}
      {% endfor %}

- name: Display tower_template_list
  debug:
    var: tower_template_list

- name: Create project job templates
  tower_job_template: "{{ item }}"
  loop: "{{ tower_template_list }}"


- name: Flatten the list of roles
  set_fact:
    tower_role_list: "{{ _role_list|from_yaml }}"
  vars:
    _role_list: |-
      {% for i in tower_organizations %}
      {% if "teams" in i %}
      {% for j in i.teams %}
      {% if "roles" in j %}
      {% for k in j.roles %}
      - {{ { 'target_team': j.name } | combine(k) }}
      {% endfor %}
      {% endif %}
      {% endfor %}
      {% endif %}
      {% endfor %}

- name: Display tower_role_list
  debug:
    var: tower_role_list

- name: Create team roles
  tower_role: "{{ item }}"
  loop: "{{ tower_role_list }}"


