---

- name: Initialize machine info
  set_fact:
    dc_os_machine_type: "dc_os_machine_type_unknown"

- name: Set machine info (container)
  when: ansible_virtualization_type in apply_common_groups_container_types
  set_fact:
    dc_os_machine_type: "dc_os_machine_type_container"

- name: Get machine type for linux family machines
  when:
    - dc_os_family in ['dc_os_linux']
    - ansible_virtualization_type not in apply_common_groups_container_types
  block:

    ## ref: https://ostechnix.com/check-linux-system-physical-virtual-machine/
    ## dmesg requires elevated perms - assume the most common usage without elevated
    - name: Get machine hypervisor status
      shell: "hostnamectl | grep -i 'chassis: vm' | wc -l"
#      shell: "dmesg | grep 'Hypervisor detected' | wc -l"
      register: __detect_hypervisor

    - debug:
        var: __detect_hypervisor
        verbosity: 2

    - name: Set machine info (linux)
      set_fact:
        dc_os_machine_type: "dc_os_machine_type_{{ 'baremetal' if __detect_hypervisor.stdout=='0' else 'vm' }}"


- name: Get machine type
  when:
    - dc_os_family not in ['dc_os_linux','dc_os_unknown']
    - ansible_virtualization_type not in apply_common_groups_container_types
  block:

    - name: Set machine info (windows)
      set_fact:
        dc_os_machine_type: "dc_os_machine_type_{{ 'vm' if ansible_virtualization_role|d('') == 'guest' else 'baremetal' }}"

- name: Group hosts based on dc_os_machine_type
#  changed_when: no
  group_by:
    key: "{{ dc_os_machine_type }}"
