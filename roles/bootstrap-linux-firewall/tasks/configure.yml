---

- name: Init firewalld vars
  include_tasks: init-vars.yml

- name: Configure firewalld custom services
  when: item.custom|d(false)
  template:
    src: service_template.xml.j2
    dest: /etc/firewalld/services/{{ item.name }}.xml
    backup: yes
  with_items: "{{ firewalld_services }}"
  notify: reload firewalld
  loop_control:
    label: "{{ item.name }}"

- name: reload firewalld
  command: firewall-cmd --reload

## ref: https://docs.ansible.com/ansible/latest/collections/ansible/posix/firewalld_module.html
- name: Configure firewalld services
  when:
    - firewalld_zones|flatten|d([])|count>0
    - firewalld_services|flatten|d([])|count>0
    - item.0.custom|d(false)
  ansible.posix.firewalld:
    zone: "{{ item.0.name }}"
    service: "{{ item.1.name }}"
    permanent: true
    state: enabled
    immediate: yes
  register: firewalld_result
  failed_when: firewalld_result is failed and 'ALREADY_ENABLED' not in firewalld_result.msg
  with_nested:
    - "{{ firewalld_zones|flatten }}"
    - "{{ firewalld_services|flatten }}"
  loop_control:
    label: "{{ item.0.name }} - {{ item.1.name }}"
  notify: reload firewalld

- name: Configure firewalld ports
  when:
    - firewalld_zones|d([])|flatten|count>0
    - firewalld_ports|d([])|flatten|count>0
  ansible.posix.firewalld:
    zone: "{{ item.0.name }}"
    port: "{{ item.1 }}"
    permanent: true
    state: enabled
    immediate: yes
  register: firewalld_result
  failed_when: firewalld_result is failed and 'ALREADY_ENABLED' not in firewalld_result.msg
  with_nested:
    - "{{ firewalld_zones|flatten }}"
    - "{{ firewalld_ports|flatten }}"
  loop_control:
    label: "{{ item.0.name }} - {{ item.1 }}"
  notify: "reload firewalld"

- name: Get services in /etc/firewalld/services
  shell: ls -1 /etc/firewalld/services/ | grep -E .xml$
  register: get_firewalld_services
  changed_when: false
  failed_when: false

- name: Remove unmanaged services in /etc/firewalld/services
  when: item|replace('.xml','') not in firewalld_services|map(attribute='name')|list
  file:
    path: "/etc/firewalld/services/{{ item }}"
    state: absent
  with_items: "{{ get_firewalld_services.stdout_lines }}"
  notify: reload firewalld

- name: Configure running firewalld
  ansible.posix.firewalld:
    immediate: "{{ item.immediate|default('yes') }}"
    interface: "{{ item.interface|default(omit) }}"
    masquerade: "{{ item.masquerade|default(omit) }}"
    permanent: "{{ item.permanent|default('no') }}"
    port: "{{ item.port|default(omit) }}"
    rich_rule: "{{ item.rich_rule|default(omit) }}"
    service: "{{ item.service|default(omit) }}"
    source: "{{ item.source|default(omit) }}"
    state: "{{ item.state|default('enabled') }}"
    zone: "{{ item.zone|default(omit) }}"
  with_items: "{{ firewalld_configs }}"

## We need this task to ensure firewall rules are loaded before
## the following tasks/roles run because they may need active firewall rules
- name: Flush all handlers
  meta: flush_handlers
