---

## ref: https://openbao.org/api-docs/system/capabilities/
## bootstrap_pki__vault_verify_token_capabilities is a list of tokens to perform capabilities verification
- name: "validate-vault-pki-tokens : Verify Vault token capabilities"
  when: bootstrap_pki__vault_verify_token_capabilities | length > 0
  ansible.builtin.uri:
    url: "{{ bootstrap_pki__vault_url }}/{{ bootstrap_pki__vault_api_version }}/sys/capabilities"
    method: POST
    headers:
      X-Vault-Token: "{{ bootstrap_pki__vault_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      token: "{{ item }}"
      paths: ["*"]
    validate_certs: false
    return_content: true
    status_code: [200, 204]
  loop: "{{ bootstrap_pki__vault_verify_token_capabilities }}"
  loop_control:
    extended: true
    label: "Token Iteration {{ ansible_loop.index }}"
  register: __token_capabilities
  delegate_to: localhost
  run_once: true
  ignore_errors: true

- name: "validate-vault-pki-tokens : Display __token_capabilities.results"
  ansible.builtin.debug:
    var: __token_capabilities.results
    verbosity: 1

- name: "validate-vault-pki-tokens : Debug token capabilities"
  when: __token_capabilities.results is defined
  ansible.builtin.debug:
    msg: "Token capabilities for {{ item.item }}: {{ item.json.capabilities
      | default('failed: ' + (item.msg | default('unknown error'))) }}"
    verbosity: 1
  loop: "{{ __token_capabilities.results }}"
  loop_control:
    extended: true
    label: "Token Iteration {{ ansible_loop.index }}"
  delegate_to: localhost
  run_once: true

#- name: "validate-vault-pki-tokens : Assert token has required capabilities"
#  ansible.builtin.assert:
#    that:
#      - "'create' in item.json.data.capabilities"
#      - "'update' in item.json.data.capabilities"
#    fail_msg: "Vault token lacks required permissions for PKI engine configuration"
#  loop: "{{ __token_capabilities.results }}"
