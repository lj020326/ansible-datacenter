---
# tasks/fetch_and_store_external_ca.yml
# Per-item logic for fetching and storing a single external CA (uses {{ __external_cert_info }} from outer loop)

- name: "setup-external-cas[{{ __external_cert_info.name }}] : Fetch from local path"
  when: __external_cert_info.local_path | d('') | length > 0
  ansible.builtin.slurp:
    src: "{{ __external_cert_info.local_path }}"
  register: __local_cert_slurp
  changed_when: false

- name: "setup-external-cas[{{ __external_cert_info.name }}] : Fetch from URL"
  when:
    - __external_cert_info.fetch_method == "url"
    - __external_cert_info.url | d('') | length > 0
  ansible.builtin.uri:
    url: "{{ __external_cert_info.url }}"
    method: GET
    return_content: true
    validate_certs: false  # For self-signed/public; adjust if needed
    status_code: 200
    headers:
      User-Agent: "Ansible-Bootstrap-PKI/1.0"
  register: __url_cert_fetch
  changed_when: false
  retries: 2  # Basic retry for transient network issues
  delay: 5

- name: "setup-external-cas[{{ __external_cert_info.name }}] : Fetch via command" # noqa: command-instead-of-shell
  when:
    - __external_cert_info.fetch_method == "command"
    - __external_cert_info.command | d('') | length > 0
  ansible.builtin.shell: "{{ __external_cert_info.command }}"  # shell for piping/features
  register: __cmd_cert_fetch
  changed_when: false
  args:
    creates: "/tmp/{{ __external_cert_info.name }}-ca.pem"  # Temp file if cmd outputs to file

- name: "setup-external-cas[{{ __external_cert_info.name }}] : Extract PEM content"
  ansible.builtin.set_fact:
    __cert_pem_content: >-
      {{
        (__external_cert_info.local_path | d('') | length > 0) | ternary(
          __local_cert_slurp.content | b64decode,
          (__external_cert_info.fetch_method == "url") | ternary(
            __url_cert_fetch.content,
            __cmd_cert_fetch.stdout
          )
        )
      }}
    __cert_description: "{{ __external_cert_info.description | d('External CA Certificate') }}"

- name: "setup-external-cas[{{ __external_cert_info.name }}] : Validate fetched cert is PEM"
  community.crypto.x509_certificate_info:
    content: "{{ __cert_pem_content }}"  # Use content (no path needed)
  register: __cert_info
  failed_when: __cert_info.failed | d(true)

- name: "setup-external-cas[{{ __external_cert_info.name }}] : Display fetched cert info"
  ansible.builtin.debug:
    msg:
      - "Fetched {{ __external_cert_info.name }}: {{ __cert_info.subject.commonName | d('N/A') }}"
      - "Valid To: {{ __cert_info.not_after }}"
      - "Description: {{ __cert_description }}"

- name: "setup-external-cas[{{ __external_cert_info.name }}] : Read existing KV value"
  community.hashi_vault.vault_kv2_get:  # v2-specific get
    url: "{{ bootstrap_pki__vault_url }}"
    token: "{{ bootstrap_pki__vault_token }}"
    mount_point: "{{ bootstrap_pki__vault_kv_mount_point }}"
    path: "trusted_external/{{ __external_cert_info.name }}"
  register: __existing_kv
  delegate_to: localhost
  run_once: true
  ignore_errors: true

- name: "setup-external-cas[{{ __external_cert_info.name }}] : Skip if unchanged"
  when:
    - not __existing_kv.failed | d(true)
    - __existing_kv.data.data.certificate | d('') == __cert_pem_content  # v2: nested data.data
  ansible.builtin.debug:
    msg: "External CA {{ __external_cert_info.name }} already up-to-date in Vault."

- name: "setup-external-cas[{{ __external_cert_info.name }}] : Store cert in Vault KV"
  when: >
    __existing_kv.failed | d(false)
    or (__existing_kv.data.data.certificate | d('') != __cert_pem_content)
  community.hashi_vault.vault_kv2_write:  # v2-specific write
    url: "{{ bootstrap_pki__vault_url }}"
    token: "{{ bootstrap_pki__vault_token }}"
    mount_point: "{{ bootstrap_pki__vault_kv_mount_point }}"
    path: "trusted_external/{{ __external_cert_info.name }}"  # Relative path
    data:
      certificate: "{{ __cert_pem_content }}"
      description: "{{ __cert_description }}"
    validate_certs: false
  register: __kv_put_result
  delegate_to: localhost
  run_once: true

- name: "setup-external-cas[{{ __external_cert_info.name }}] : Display KV store result"
  when: __kv_put_result.changed | d(false) # noqa: no-handler
  ansible.builtin.debug:
    msg: "Stored {{ __external_cert_info.name }} in {{
      bootstrap_pki__vault_kv_mount_point }}/trusted_external (changed: {{ __kv_put_result.changed }})"

- name: "setup-external-cas[{{ __external_cert_info.name }}] : Increment stored counter if changed"
  when: __kv_put_result.changed | d(false) # noqa: no-handler
  ansible.builtin.set_fact:
    __external_ca_stored_count: "{{ __external_ca_stored_count | int + 1 }}"
