---
- name: "encrypt-root-ca-key : Validate vault password is provided when encryption is enabled"
  ansible.builtin.assert:
    that:
      - bootstrap_pki__vault_password | length > 0
    fail_msg: "bootstrap_pki__vault_password must be provided when bootstrap_pki__encrypt_root_ca_key is true"

- name: "encrypt-root-ca-key : Check if root CA key is already encrypted"
  no_log: true
  ansible.builtin.stat:
    path: "{{ bootstrap_pki__encrypted_root_ca_key_path }}"
  register: __encrypted_key_stat

- name: "encrypt-root-ca-key : Encrypt root CA key with Ansible Vault"
  when: not __encrypted_key_stat.stat.exists | d(false)
  ansible.builtin.command:
    cmd: >
      ansible-vault encrypt {{ bootstrap_pki__ca_dir }}/{{ bootstrap_pki__ca_root_cert_info.cert_basename }}-key.pem
      --output {{ bootstrap_pki__encrypted_root_ca_key_path }}
      --vault-password-file /bin/cat
    stdin: "{{ ansible_vault_password }}"
  args:
    creates: "{{ bootstrap_pki__encrypted_root_ca_key_path }}"
  register: __encrypt_key_result
  changed_when: __encrypt_key_result.rc == 0

- name: "encrypt-root-ca-key : Remove unencrypted root CA key"
  when: __encrypted_key_stat.stat.exists | d(false)
  ansible.builtin.file:
    path: "{{ bootstrap_pki__ca_dir }}/{{ bootstrap_pki__ca_root_cert_info.cert_basename }}-key.pem"
    state: absent
