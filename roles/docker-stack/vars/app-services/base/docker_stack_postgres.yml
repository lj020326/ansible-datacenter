---

__docker_stack_appspecs__postgres_pgadmin_username: "{{ pgadmin_username | d('pgadmin4@pgadmin.org') }}"
__docker_stack_appspecs__postgres_pgadmin_password: "{{ pgadmin_password | d('admin') }}"
__docker_stack_appspecs__postgres_pgadmin_port: "5050"

__docker_stack_appspecs__postgres_port: 5432
__docker_stack_appspecs__postgres_user: "{{ postgres_user | d('postgres') }}"
__docker_stack_appspecs__postgres_password: "{{ postgres_password | d('password') }}"
__docker_stack_appspecs__postgres_databases: "{{ docker_stack_postgres_databases | d([]) }}"

__docker_stack_appspecs__pgadmin_use_ldap: "{{ docker_stack_pgadmin_config_use_ldap | d(False) }}"

__docker_stack_appspecs__pgadmin_config_default:
  PGADMIN_DEFAULT_EMAIL: "{{ __docker_stack_appspecs__postgres_pgadmin_username }}"
  PGADMIN_DEFAULT_PASSWORD: "{{ __docker_stack_appspecs__postgres_pgadmin_password }}"

## ref: https://www.pgadmin.org/docs/pgadmin4/latest/config_py.html#config-py
## reF: https://www.pgadmin.org/docs/pgadmin4/5.0/enabling_ldap_authentication.html
__docker_stack_appspecs__pgadmin_ldap_config_default:
  PGADMIN_CONFIG_LDAP_SERVER_URI: "{{ docker_stack_pgadmin_config_ldap_server_uri | d('') }}"
  PGADMIN_CONFIG_LDAP_USERNAME_ATTRIBUTE: "uid"
  PGADMIN_CONFIG_LDAP_BASE_DN: "{{ docker_stack_pgadmin_config_ldap_base_dn | d('') }}"
  PGADMIN_CONFIG_LDAP_SEARCH_BASE_DN: "{{ docker_stack_pgadmin_config_ldap_search_base_dn | d('') }}"
  PGADMIN_CONFIG_LDAP_SEARCH_FILTER: "{{ docker_stack_pgadmin_config_ldap_search_filter | d('(cn=*)') }}"

__docker_stack_appspecs__pgadmin_ldap_config: "{{ __docker_stack_appspecs__pgadmin_ldap_config_default if __docker_stack_appspecs__pgadmin_use_ldap else {} }}"

__docker_stack_appspecs__pgadmin_config: "{{ __docker_stack_appspecs__pgadmin_config_default | combine(__docker_stack_appspecs__pgadmin_ldap_config) }}"

#.__docker_stack_appspecs__pgadmin_ldap_config: &tpl__docker_stack_appspecs__pgadmin_ldap_config
#  "{{ __docker_stack_appspecs__pgadmin_ldap_config }}"

docker_stack_appspec_config_dirs__postgres:
  - { path: "{{ docker_stack_dir }}/postgres" }
  - { path: "{{ docker_stack_dir }}/postgres/multiple-dbs" }
  - { path: "{{ docker_stack_dir }}/postgres/config" }
  - { path: "{{ docker_stack_dir }}/postgres/data", mode: "0750"}
  - { path: "{{ docker_stack_dir }}/pgadmin" }
  - { path: "{{ docker_stack_dir }}/pgadmin/data" }
  - { path: "{{ docker_stack_dir }}/pgadmin/config" }
  - { path: "{{ docker_stack_dir }}/pgadmin/log" }
  - { path: "{{ docker_stack_dir }}/pgadmin/log/pgadmin" }

docker_stack_appspec_config_tpls__postgres:
  - { src: 'postgres/config-passwd.conf.j2', dest: "{{ docker_stack_dir }}/postgres/passwd" }
  - { src: 'postgres/config-group.conf.j2', dest: "{{ docker_stack_dir }}/postgres/group" }
  - { src: 'pgadmin/config-passwd.conf.j2', dest: "{{ docker_stack_dir }}/pgadmin/passwd" }
  - { src: 'pgadmin/config-group.conf.j2', dest: "{{ docker_stack_dir }}/pgadmin/group" }

docker_stack_firewalld_appspec_ports__postgres:
  - "{{ __docker_stack_appspecs__postgres_port }}/tcp"

docker_stack_appspec__postgres:
  dirs: "{{ docker_stack_appspec_config_dirs__postgres | d([]) }}"
  files: "{{ docker_stack_appspec_config_files__postgres | d([]) }}"
  templates: "{{ docker_stack_appspec_config_tpls__postgres | d([]) }}"
  firewalld_services: "{{ docker_stack_firewalld_appspec_services__postgres | d([]) }}"
  firewalld_ports: "{{ docker_stack_firewalld_appspec_ports__postgres | d([]) }}"
  docker_services: "{{ docker_stack_appspec_services__postgres | d({}) }}"
