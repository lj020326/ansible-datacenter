---

docker_stack_appspec_services__jenkins_jcac:

  ## ref: https://github.com/jenkinsci/docker
  ## ref: https://medium.com/swlh/quickstart-ci-with-jenkins-and-docker-in-docker-c3f7174ee9ff
  ## ref: https://github.com/4OH4/jenkins-docker
  ## ref: https://github.com/lj020326/jenkins-docker
  jenkins_jcac:
    image: "{{ __docker_stack_appspecs__jenkins_jcac_image }}"
    container_name: jenkins_jcac
    restart: "unless-stopped"
    depends_on:
      - socket-proxy
    user: "{{ docker_stack_user_uid }}:{{ docker_stack_user_gid }}"
    networks:
      - "{{ docker_stack_traefik_proxy_network }}"
      - socket_proxy
    ports:
      - "{{ __docker_stack_appspecs__jenkins_jcac_http }}:8080/tcp"  ## jenkins web server
      - "{{ __docker_stack_appspecs__jenkins_jcac_agent_port }}:9000/tcp"
#      command: "--httpsCertificate=/var/lib/jenkins/cert --httpsPrivateKey=/var/lib/jenkins/pk"
    volumes:
#        - "/var/run/docker.sock:/var/run/docker.sock"
      - "{{ __docker_stack_appspecs__jenkins_jcac_base_dir }}/passwd:/etc/passwd:ro"
      - "{{ __docker_stack_appspecs__jenkins_jcac_base_dir }}/group:/etc/group:ro"
      - "{{ __docker_stack_appspecs__jenkins_jcac_base_dir }}/jenkins_home:/var/jenkins_home"
#      - "{{ __docker_stack_appspecs__jenkins_jcac_base_dir }}/jenkins_home:/home/jenkins"
      - "{{ docker_stack_ca_cert_bundle }}:/etc/ssl/certs/ca-certificates.crt:ro"
      - "{{ docker_stack_ca_java_keystore }}:/var/lib/jenkins/cacerts"
      - "{{ __docker_stack_appspecs__jenkins_jcac_data_dir }}:/data"
      - "{{ __docker_stack_vmware_data_dir }}:/vmware"
    environment:
      TZ: "{{ docker_stack_timezone }}"
      JENKINS_SLAVE_AGENT_PORT: 9000
      JENKINS_OPTS: "--prefix=/jenkins"
      JAVA_OPTS: "-Djava.awt.headless=true -Djavax.net.ssl.trustStore=/var/lib/jenkins/cacerts -Djavax.net.ssl.trustStorePassword=changeit"
      ## ref: https://github.com/jenkinsci/docker/pull/577
#        PLUGINS_FORCE_UPGRADE: 'true'
#        JENKINS_UC_DOWNLOAD: "http://updates.jenkins.io"
#        JENKINS_UC_DOWNLOAD: "http://updates.jenkins-ci.org"
#        JENKINS_UC_DOWNLOAD: "https://mirrors.xmission.com/jenkins/updates/update-center.json"
    labels:
      traefik.enable: true
      traefik.http.routers.jenkins.entrypoints: https
      traefik.http.routers.jenkins.rule: Host(`{{ docker_stack_internal_domain }}`) && PathPrefix(`/jenkins`)
      ## ref: https://community.traefik.io/t/pathprefix-and-strip/2122/2
      traefik.http.services.jenkins.loadbalancer.server.port: 8080
#      traefik.http.routers.jenkins_insecure.entrypoints: http
#      traefik.http.routers.jenkins_insecure.rule: Host(`{{ docker_stack_internal_domain }}`) && PathPrefix(`/jenkins`)
#      traefik.http.routers.jenkins_insecure.middlewares: https-only@file
