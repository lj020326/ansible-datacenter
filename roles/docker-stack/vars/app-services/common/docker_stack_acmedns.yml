---

__docker_stack_appspecs__acmedns_stack_dir: "{{ docker_stack_dir | d('/home/user/docker-dirs') }}"

__docker_stack_appspecs__acmedns_http_port: "{{ docker_stack_acmedns_http_port | d('5080') }}"
__docker_stack_appspecs__acmedns_https_port: "{{ docker_stack_acmedns_https_port | d('5443') }}"
__docker_stack_appspecs__acmedns_dns_port: "{{ docker_stack_acmedns_dns_port | d('5353') }}"

__docker_stack_appspecs__acmedns_domain: "{{ docker_stack_acmedns_domain | d('auth.example.org') }}"
# zone name server
__docker_stack_appspecs__acmedns_nsname: "{{ docker_stack_acmedns_nsname | d('auth.example.org') }}"
# admin email address, where @ is substituted with .
__docker_stack_appspecs__acmedns_nsadmin: "{{ docker_stack_acmedns_nsadmin | d('admin.example.org') }}"

__docker_stack_appspecs__acmedns_ip: "{{ docker_stack_acmedns_ip | d('198.51.100.1') }}"

__docker_stack_appspecs__acmedns_parent_domain: "{{ __docker_stack_appspecs__acmedns_domain.split('.')[1::] | join('.') }}"
__docker_stack_appspecs__acmedns_tls_certdir: "/etc/tls/{{ __docker_stack_appspecs__acmedns_parent_domain }}"

__docker_stack_appspecs__acmedns_tls_cert_host_privkey: "{{ docker_stack_acmedns_tls_cert_host_privkey | d('/etc/ssl/private/privkey.pem') }}"
__docker_stack_appspecs__acmedns_tls_cert_host_fullchain: "{{ docker_stack_acmedns_tls_cert_host_fullchain | d('/etc/ssl/certs/fullchain.pem') }}"

__docker_stack_appspecs__acmedns_tls_cert_privkey: "{{ docker_stack_acmedns_tls_cert_privkey | d(__docker_stack_appspecs__acmedns_tls_certdir + '/privkey.pem') }}"
__docker_stack_appspecs__acmedns_tls_cert_fullchain: "{{ docker_stack_acmedns_tls_cert_fullchain | d(__docker_stack_appspecs__acmedns_tls_certdir + '/fullchain.pem') }}"

docker_stack_appspec_config_dirs__acmedns:
  - { path: "{{ docker_stack_dir }}/acmedns" }
  - { path: "{{ docker_stack_dir }}/acmedns/config" }
  - { path: "{{ docker_stack_dir }}/acmedns/data" }

docker_stack_appspec_config_tpls__acmedns:
  - { src: 'acmedns/config.cfg.j2', dest: "{{ __docker_stack_appspecs__acmedns_stack_dir }}/acmedns/config/config.cfg"}

docker_stack_firewalld_appspec_ports__acmedns:
  - "{{ __docker_stack_appspecs__acmedns_http_port }}/tcp"
  - "{{ __docker_stack_appspecs__acmedns_https_port }}/tcp"
  - "{{ __docker_stack_appspecs__acmedns_dns_port }}/tcp"

#docker_stack_appspec_config_tpls__acmedns:
#  - { src: "acmedns/acmedns.xml.j2", dest: "{{ docker_stack_dir }}/acmedns/conf/acmedns.xml" }

docker_stack_appspec_networks__acmedns:
  ## ref: https://github.com/stefanprodan/swarmprom/blob/master/docker-compose.traefik.yml
  net:
    external: false
    attachable: true

__docker_stack_appspecs__traefik_labels_acmedns: "{{ docker_stack_appspecs__traefik_labels_acmedns | d(__docker_stack_appspecs__traefik_labels_acmedns_default) }}"

docker_stack_appspec_services__acmedns:
  ## https://github.com/joohoi/acme-dns
  ## https://raw.githubusercontent.com/joohoi/acme-dns/master/docker-compose.yml
  acmedns:
    container_name: acmedns
    image: joohoi/acme-dns:latest
#    user: "{{ docker_stack_user_uid }}:{{ docker_stack_user_gid }}"
    restart: "unless-stopped"
    ports:
      - "{{ __docker_stack_appspecs__acmedns_dns_port }}:53"
      - "{{ __docker_stack_appspecs__acmedns_dns_port }}:53/udp"
#      - "80:80"
#      - "443:443"
      - "{{ __docker_stack_appspecs__acmedns_http_port }}:80"
      - "{{ __docker_stack_appspecs__acmedns_https_port }}:443"
    networks:
      - "{{ docker_stack_traefik_proxy_network }}"
      - net
    volumes:
#      - ./config:/etc/acme-dns:ro
#      - ./data:/var/lib/acme-dns
      - "{{ docker_stack_dir }}/acmedns/config:/etc/acme-dns:ro"
      - "{{ docker_stack_dir }}/acmedns/data:/var/lib/acme-dns"
      - "{{ __docker_stack_appspecs__acmedns_tls_cert_host_privkey }}:/etc/tls/privkey.pem"
      - "{{ __docker_stack_appspecs__acmedns_tls_cert_host_fullchain }}:/etc/tls/fullchain.pem"
    labels: "{{ __docker_stack_appspecs__traefik_labels_acmedns }}"

docker_stack_appspec__acmedns:
  dirs: "{{ docker_stack_appspec_config_dirs__acmedns | d([]) }}"
  files: "{{ docker_stack_appspec_config_files__acmedns | d([]) }}"
  templates: "{{ docker_stack_appspec_config_tpls__acmedns | d([]) }}"
  firewalld_services: "{{ docker_stack_firewalld_appspec_services__acmedns | d([]) }}"
  firewalld_ports: "{{ docker_stack_firewalld_appspec_ports__acmedns | d([]) }}"
  networks: "{{ docker_stack_appspec_networks__acmedns | d({}) }}"
  docker_services: "{{ docker_stack_appspec_services__acmedns | d({}) }}"

