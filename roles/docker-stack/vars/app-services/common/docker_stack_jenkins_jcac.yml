---

__docker_stack_jenkins_jcac_stack_dir: "{{ docker_stack_dir | d('/home/user/docker-dirs') }}"
__docker_stack_jenkins_jcac_base_dir: "{{ docker_stack_jenkins_jcac_dir | d(__docker_stack_jenkins_jcac_stack_dir + '/jenkins_jcac') }}"

__docker_stack_jenkins_jcac_agent_base_dir_default: "{{ __docker_stack_jenkins_jcac_stack_dir }}/jenkins_agent"
__docker_stack_jenkins_jcac_agent_base_dir: "{{ docker_stack_jenkins_jcac_agent_base_dir
  | d(__docker_stack_jenkins_jcac_agent_base_dir_default) }}"

__docker_stack_jenkins_jcac_http: "{{ docker_stack_jenkins_jcac_http | d('10180') }}"

## ref: https://www.jenkins.io/blog/2020/05/11/docker-windows-agents/
## ref: https://support.cloudbees.com/hc/en-us/articles/115001771692-How-to-Create-Permanent-Agents-with-Docker
## ref: https://github.com/jenkinsci/docker-inbound-agent
## ref: https://wiki.tds.tieto.com/display/TDSKB/Executing+Jenkins+jobs+when+only+one+way+network+connection+exists
__docker_stack_jenkins_jcac_agent_port: "{{ docker_stack_jenkins_jcac_agent_port | d('9000') }}"
__docker_stack_jenkins_jcac_agent_tcp_port: "{{ docker_stack_jenkins_jcac_tcp_port | d('9000') }}"
__docker_stack_jenkins_jcac_agent_ssh_port: "{{ docker_stack_jenkins_jcac_ssh_port | d('4444') }}"

__docker_stack_jenkins_jcac_mgr_pwd_secret: "{{ docker_stack_jenkins_jcac_mgr_pwd_secret | d('00000000000000000000000') }}"

## ref: https://www.jenkins.io/blog/2020/05/11/docker-windows-agents/
#__docker_stack_jenkins_jcac_image: "jenkins/jenkins:lts"
__docker_stack_jenkins_jcac_image: "{{ docker_stack_jenkins_jcac_image | d(docker_stack_registry_endpoint + '/jenkins-docker-jcac:latest') }}"
__docker_stack_jenkins_jcac_agent_image_default: "registry.example.int:5000/jenkins-docker-cicd-agent:latest"
__docker_stack_jenkins_jcac_agent_image: "{{ docker_stack_jenkins_jcac_agent_image | d(__docker_stack_jenkins_jcac_agent_image_default) }}"

__docker_stack_jenkins_jcac_ldap_host: "{{ docker_stack_jenkins_jcac_ldap_host | d(docker_stack_ldap_host)}}"
__docker_stack_jenkins_jcac_ldap_base_dn: "{{ docker_stack_jenkins_jcac_ldap_base_dn | d(docker_stack_ldap_base_dn)}}"

__docker_stack_jenkins_jcac_ldap_readonly_password: "{{ docker_stack_jenkins_jcac_ldap_readonly_password | d(docker_stack_ldap_readonly_password)}}"

__docker_stack__jenkins_ssh_private_key: "{{ docker_stack_jenkins_ssh_private_key | d('') }}"
__docker_stack__jenkins_ssh_public_key: "{{ docker_stack_jenkins_ssh_public_key | d('') }}"

#__docker_stack_jenkins_jcac_data_dir: /export/data/jenkins/osimages
#__docker_stack_jenkins_jcac_data_dir: /export/data/jenkins
__docker_stack_jenkins_jcac_data_dir: /data/datacenter/jenkins

__docker_stack_jenkins_jcac_vmware_data_dir_default: /data/datacenter/vmware
__docker_stack_jenkins_jcac_vmware_data_dir: "{{ docker_stack_jenkins_jcac_vmware_data_dir | d(__docker_stack_jenkins_jcac_vmware_data_dir_default) }}"

docker_stack_appspec_config_dirs__jenkins_jcac:
  - path: "{{ __docker_stack_jenkins_jcac_base_dir }}"
  - path: "{{ __docker_stack_jenkins_jcac_base_dir }}/jenkins_home"
  - path: "{{ __docker_stack_jenkins_jcac_base_dir }}/jenkins_home/casc_configs"
  - path: "{{ __docker_stack_jenkins_jcac_data_dir }}"
  - path: "{{ __docker_stack_jenkins_jcac_data_dir }}/osimages"
#  - path: "{{ __docker_stack_jenkins_jcac_agent_base_dir }}"
#  - path: "{{ __docker_stack_jenkins_jcac_agent_base_dir }}/jenkins_home"
#  - path: "{{ __docker_stack_jenkins_jcac_swarm_base_dir }}"
#  - path: "{{ __docker_stack_jenkins_jcac_swarm_base_dir }}/jenkins_home"

docker_stack_appspec_config_tpls__jenkins_jcac:
  - src: 'jenkins_jcac/jenkins.env.j2'
    dest: "{{ __docker_stack_jenkins_jcac_base_dir }}/jenkins.env"
  ## TODO: move ssh key storage to jenkins secret based implementation
  ## resolve host key verification error for ssh based repos
  ## ref: https://stackoverflow.com/questions/15174194/jenkins-host-key-verification-failed#15196114
#  - src: 'jenkins_jcac/ssh/ssh_private_key.j2'
#    dest: "{{ __docker_stack_jenkins_jcac_base_dir }}/jenkins_home/.ssh/id_rsa"
#    mode: "0600"
#  - src: 'jenkins_jcac/ssh/ssh_public_key.j2'
#    dest: "{{ __docker_stack_jenkins_jcac_base_dir }}/jenkins_home/.ssh/id_rsa.pub"
  - src: 'jenkins_jcac/jenkins_casc.yml.j2'
    dest: "{{ __docker_stack_jenkins_jcac_base_dir }}/jenkins_home/casc_configs/jenkins.yml"
  - src: 'jenkins_jcac/job_dsl/seedjob.groovy'
    dest: "{{ __docker_stack_jenkins_jcac_base_dir }}/jenkins_home/casc_configs/seedjob.groovy"
  - src: 'jenkins_jcac/config-group.conf.j2'
    dest: "{{ __docker_stack_jenkins_jcac_base_dir }}/group"
  - src: 'jenkins_jcac/config-passwd.conf.j2'
    dest: "{{ __docker_stack_jenkins_jcac_base_dir }}/passwd"
#  - src: 'jenkins_jcac/config-agent-group.conf.j2'
#    dest: "{{ __docker_stack_jenkins_jcac_agent_base_dir }}/group"
#  - src: 'jenkins_jcac/config-agent-passwd.conf.j2'
#    dest: "{{ __docker_stack_jenkins_jcac_agent_base_dir }}/passwd"
#  - src: 'jenkins_jcac/config-agent-group.conf.j2'
#    dest: "{{ __docker_stack_jenkins_jcac_swarm_base_dir }}/group"
#  - src: 'jenkins_jcac/config-agent-passwd.conf.j2'
#    dest: "{{ __docker_stack_jenkins_jcac_swarm_base_dir }}/passwd"

docker_stack_firewalld_appspec_ports__jenkins_jcac:
  - "{{ __docker_stack_jenkins_jcac_agent_tcp_port }}/tcp"
  - "{{ __docker_stack_jenkins_jcac_agent_ssh_port }}/tcp"


docker_stack_appspec__jenkins_jcac:
  dirs: "{{ docker_stack_appspec_config_dirs__jenkins_jcac | d([]) }}"
  files: "{{ docker_stack_appspec_config_files__jenkins_jcac | d([]) }}"
  templates: "{{ docker_stack_appspec_config_tpls__jenkins_jcac | d([]) }}"
  firewalld_services: "{{ docker_stack_firewalld_appspec_services__jenkins_jcac | d([]) }}"
  firewalld_ports: "{{ docker_stack_firewalld_appspec_ports__jenkins_jcac | d([]) }}"
  networks: "{{ docker_stack_appspec_networks__jenkins_jcac | d({}) }}"
  volumes: "{{ docker_stack_appspec_volumes__jenkins_jcac | d({}) }}"
  docker_services: "{{ docker_stack_appspec_services__jenkins_jcac | d({}) }}"

__docker_stack_appspecs__traefik_labels_jenkins_jcac: "{{ docker_stack_appspecs__traefik_labels_jenkins_jcac
  | d(__docker_stack_appspecs__traefik_labels_jenkins_jcac_default) }}"

docker_stack_appspec_services__jenkins_jcac:

  ## ref: https://github.com/jenkinsci/docker
  ## ref: https://medium.com/swlh/quickstart-ci-with-jenkins-and-docker-in-docker-c3f7174ee9ff
  ## ref: https://github.com/4OH4/jenkins-docker
  ## ref: https://github.com/lj020326/jenkins-docker
  jenkins-jcac:
    image: "{{ __docker_stack_jenkins_jcac_image }}"
    container_name: jenkins-jcac
    restart: "unless-stopped"
#    depends_on:
#      - socket-proxy
    user: "{{ docker_stack_user_uid }}:{{ docker_stack_user_gid }}"
    networks:
      - "{{ docker_stack_traefik_proxy_network }}"
      - socket_proxy
    ports:
      - "{{ __docker_stack_jenkins_jcac_http }}:8080/tcp"  ## jenkins web server
      - "{{ __docker_stack_jenkins_jcac_agent_port }}:9000/tcp"
#      command: "--httpsCertificate=/var/lib/jenkins/cert --httpsPrivateKey=/var/lib/jenkins/pk"
    volumes:
#      - "{{ __docker_stack_jenkins_jcac_base_dir }}/casc_configs/jenkins_casc.yml:/var/jenkins_casc.yml"
      - "{{ __docker_stack_jenkins_jcac_base_dir }}/passwd:/etc/passwd:ro"
      - "{{ __docker_stack_jenkins_jcac_base_dir }}/group:/etc/group:ro"
      - "{{ __docker_stack_jenkins_jcac_base_dir }}/jenkins_home:/var/jenkins_home"
      - "{{ __docker_stack_ca_cert_bundle }}:/etc/ssl/certs/ca-certificates.crt:ro"
      - "{{ __docker_stack_ca_java_keystore }}:/var/lib/jenkins/cacerts"
      - "{{ __docker_stack_jenkins_jcac_data_dir }}:/data"
      - "{{ __docker_stack_jenkins_vmware_data_dir }}:/vmware"
    env_file:
      - jenkins_jcac/jenkins.env
    labels: "{{ __docker_stack_appspecs__traefik_labels_jenkins_jcac }}"

__docker_stack_jenkins_cred_docker_registry_admin_password: "{{ docker_stack_jenkins_cred_docker_registry_admin_password | d('CHANGEME123') }}"

__docker_stack_jenkins_cred_jenkins_admin_user_password: "{{ docker_stack_jenkins_cred_jenkins_admin_user_password | d('CHANGEME123') }}"
__docker_stack_jenkins_cred_jenkins_git_user_password: "{{ docker_stack_jenkins_cred_jenkins_git_user_password | d('CHANGEME123') }}"

__docker_stack_jenkins_cred_ansible_ssh_key: "{{ docker_stack_jenkins_cred_ansible_ssh_key | d('CHANGEME123') }}"
__docker_stack_jenkins_cred_ansible_vault_password: "{{ docker_stack_jenkins_cred_ansible_vault_password | d('CHANGEME123') }}"
__docker_stack_jenkins_cred_ansible_ssh_password: "{{ docker_stack_jenkins_cred_ansible_ssh_password | d('CHANGEME123') }}"

__docker_stack_jenkins_cred_vsphere_password: "{{ docker_stack_jenkins_cred_vsphere_password | d('CHANGEME123') }}"
__docker_stack_jenkins_cred_esxi_password: "{{ docker_stack_jenkins_cred_esxi_password | d('CHANGEME123') }}"
__docker_stack_jenkins_cred_bitbucket_ssh_username: "{{ docker_stack_jenkins_cred_bitbucket_ssh_username | d('CHANGEME123') }}"
__docker_stack_jenkins_cred_bitbucket_ssh_private_key: "{{ docker_stack_jenkins_cred_bitbucket_ssh_private_key | d('CHANGEME123') }}"
__docker_stack_jenkins_cred_packer_ssh_password: "{{ docker_stack_jenkins_cred_packer_ssh_password | d('CHANGEME123') }}"
__docker_stack_jenkins_cred_vm_root_password: "{{ docker_stack_jenkins_cred_vm_root_password | d('CHANGEME123') }}"
__docker_stack_jenkins_cred_github_username: "{{ docker_stack_jenkins_cred_github_username | d('CHANGEME123') }}"
__docker_stack_jenkins_cred_github_password: "{{ docker_stack_jenkins_cred_github_password | d('CHANGEME123') }}"

__docker_stack_jenkins_github_repo_seedjob_dsl_default: lj020326/jenkins-docker
__docker_stack_jenkins_github_repo_seedjob_dsl: "{{ docker_stack_jenkins_github_repo_seedjob_dsl
  | d(__docker_stack_jenkins_github_repo_seedjob_dsl_default) }}"
