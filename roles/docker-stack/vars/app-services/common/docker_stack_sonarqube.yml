---

__docker_stack__appspecs__sonarqube_stack_dir: "{{ docker_stack__dir | d('/home/user/docker-dirs') }}"

__docker_stack__appspecs__sonarqube_http: "{{ docker_stack__sonarqube_http | d('10180') }}"

#__docker_stack__appspecs__sonarqube_image: "{{ docker_stack__registry_endpoint }}/sonarqube:latest"
__docker_stack__appspecs__sonarqube_image: "sonarqube:community"

__docker_stack__appspecs__sonarqube_db: sonar
__docker_stack__appspecs__sonarqube_db_user: test
__docker_stack__appspecs__sonarqube_db_password: test


#__docker_stack__appspecs__sonarqube_data_dir: /export/data/sonarqube/osimages
#__docker_stack__appspecs__sonarqube_data_dir: /export/data/sonarqube

docker_stack__appspec_config_dirs__sonarqube:
  - { path: "{{ __docker_stack__appspecs__sonarqube_stack_dir }}/sonarqube" }

#docker_stack__appspec_config_tpls__sonarqube:
#  - { src: 'sonarqube/config-group.conf.j2', dest: "{{ __docker_stack__appspecs__sonarqube_stack_dir }}/sonarqube/group" }
#  - { src: 'sonarqube/config-passwd.conf.j2', dest: "{{ __docker_stack__appspecs__sonarqube_stack_dir }}/sonarqube/passwd" }

docker_stack__firewalld_appspec_ports__sonarqube:
  - "{{ __docker_stack__appspecs__sonarqube_agent_tcp_port }}/tcp"


docker_stack__appspec_volumes__sonarqube:
  sonar_psql:
    driver: local
    driver_opts:
        type: none
        device: "$PWD/sonar_psql"
        o: bind

  sonar_psql_data:
    driver: local
    driver_opts:
        type: none
        device: "$PWD/sonar_psql_data"
        o: bind

  sonarqube_data:
    driver: local
    driver_opts:
        type: none
        device: "$PWD/sonarqube_data"
        o: bind

  sonarqube_extensions:
    driver: local
    driver_opts:
        type: none
        device: "$PWD/sonarqube_extensions"
        o: bind

  sonarqube_logs:
    driver: local
    driver_opts:
        type: none
        device: "$PWD/sonarqube_logs"
        o: bind


docker_stack__appspec__sonarqube:
  dirs: "{{ docker_stack__appspec_config_dirs__sonarqube | d([]) }}"
  files: "{{ docker_stack__appspec_config_files__sonarqube | d([]) }}"
  templates: "{{ docker_stack__appspec_config_tpls__sonarqube | d([]) }}"
  firewalld_services: "{{ docker_stack__firewalld_appspec_services__sonarqube | d([]) }}"
  firewalld_ports: "{{ docker_stack__firewalld_appspec_ports__sonarqube | d([]) }}"
  networks: "{{ docker_stack__appspec_networks__sonarqube | d({}) }}"
  volumes: "{{ docker_stack__appspec_volumes__sonarqube | d({}) }}"
  docker_services: "{{ docker_stack__appspec_services__sonarqube | d({}) }}"


__docker_stack__traefik__labels_sonarqube: "{{ docker_stack__traefik__labels_sonarqube
  | d(__docker_stack__traefik__labels_sonarqube_default) }}"

## ref: https://community.traefik.io/t/using-ports-endpoints-for-containers/9386
## ref: https://techexpert.tips/sonarqube/sonarqube-docker-installation/
docker_stack__appspec_services__sonarqube:
  sonar-db:
    image: 'postgres:10'
    restart: unless-stopped
    depends_on:
        - sonarqube
    networks:
      - net
    labels:
      - traefik.enable=false
    volumes:
      - "sonar_psql:/var/lib/postgresql"
      - "sonar_psql_data:/var/lib/postgresql/data"
    environment:
      POSTGRES_DB: "{{ __docker_stack__appspecs__sonarqube_db }}"
      POSTGRES_USER: "{{ __docker_stack__appspecs__sonarqube_db_user }}"
      POSTGRES_PASSWORD: "{{ __docker_stack__appspecs__sonarqube_db_password }}"

  sonarqube:
    container_name: sonarqube
    hostname: sonarqube
    image: "{{ __docker_stack__appspecs__sonarqube_image }}"
    networks:
      - "{{ docker_stack__traefik_proxy_network }}"
      - net
    labels: "{{ __docker_stack__traefik__labels_sonarqube }}"
    environment:
      SONAR_JDBC_URL: "jdbc:postgresql://sonar-db:5432/{{ __docker_stack__appspecs__sonarqube_db }}"
      SONAR_JDBC_USERNAME: "{{ __docker_stack__appspecs__sonarqube_db_user }}"
      SONAR_JDBC_PASSWORD: "{{ __docker_stack__appspecs__sonarqube_db_password }}"
    restart: unless-stopped
    volumes:
      - "sonarqube_data:/opt/sonarqube/data"
      - "sonarqube_extensions:/opt/sonarqube/extensions"
      - "sonarqube_logs:/opt/sonarqube/logs"

