---

- set_fact:
    log_prefix_local: "Docker Stack | Setup Service Configs |"

- name: "{{ log_prefix_local }} Install docker stack service templates"
  template:
    backup: "{{ item.backup | default(True) }}"
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
#    force: "{{ docker_stack_overwrite_configs }}"
    mode: "{{ item.mode | default('0664') }}"
    owner: "{{ docker_stack_user_username }}"
    group: "{{ docker_stack_user_group }}"
  with_items: "{{ docker_stack_service_templates }}"

- name: "{{ log_prefix_local }} Install docker stack proxy service templates"
  when: __docker_stack_proxy_services | length > 0
  template:
    backup: "{{ item.backup | default(True) }}"
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
#    force: "{{ docker_stack_overwrite_configs }}"
    mode: "{{ item.mode | default('0664') }}"
    owner: "{{ docker_stack_user_username }}"
    group: "{{ docker_stack_user_group }}"
  with_items: "{{ docker_stack_proxy_service_templates }}"

- name: "{{ log_prefix_local }} Create docker secrets for stack if necessary"
  when: item.value.external|d(False)|bool
  community.docker.docker_secret:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    labels: "{{ item.labels | d(omit) }}"
    state: present
  with_dict: "{{ __docker_stack_secrets }}"

- name: "{{ log_prefix_local }} Create external docker networks for stack if necessary"
  block:

  - name: "{{ log_prefix_local }} Display __docker_stack_networks"
    debug:
      var: __docker_stack_networks
      verbosity: 1

  - name: "{{ log_prefix_local }} Create external docker networks for stack if necessary"
    when: item.value.external|d(False)|bool
    community.docker.docker_network:
      name: "{{ item.key }}"
    with_dict: "{{ __docker_stack_networks }}"
    register: __configure_docker_service

  rescue:

    - name: "{{ log_prefix_local }} Handle docker service exception"
      include_tasks: handle-docker-service-exception.yml

    - name: "{{ log_prefix_local }} Create external docker networks for stack if necessary"
      when: item.value.external|d(False)|bool
      community.docker.docker_network:
        name: "{{ item.key }}"
      with_dict: "{{ __docker_stack_networks }}"
      register: __configure_docker_service
