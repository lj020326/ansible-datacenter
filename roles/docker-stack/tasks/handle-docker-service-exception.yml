---

- set_fact:
    __log_prefix_local: "Docker Stack | Handle Service Config Exception |"

- name: "{{ __log_prefix_local }} Assert __configure_docker_service is defined"
  assert:
    that: __configure_docker_service is defined

- name: "{{ __log_prefix_local }} Display __configure_docker_service"
  debug:
    var: __configure_docker_service

- name: "{{ __log_prefix_local }} Set __ip_table_error"
  when:
    - item.failed|d(False)|bool
    - (item.msg is search('Failed to Setup IP tables') or item.msg is search('INVALID_ZONE.* docker') )
  set_fact:
    __ip_table_error: yes
  loop: "{{ __configure_docker_service.results|d([]) }}"

- name: "{{ __log_prefix_local }} Display __ip_table_error"
  debug:
    var: __ip_table_error

- name: "{{ __log_prefix_local }} Re-emit failure"
  when: not __ip_table_error|d(False)|bool
  vars:
    failed_task:
      result: "{{ ansible_failed_result }}"
  fail:
    msg: "{{ failed_task }}"

- name: "{{ __log_prefix_local }} Restart docker service"
  include_tasks: restart-docker-service.yml
