---

- name: "Setup docker user facts"
  include_tasks: init-vars.yml

- name: "Setup firewalld config"
  when: docker_stack_firewalld_enabled | default(True) | bool
  include_tasks: setup-firewalld.yml

- name: "Setup docker app dirs and configs"
  when: docker_stack_action == 'setup'
  include_tasks: setup-app-configs.yml

- name: "Setup self-signed certs"
  when:
    - docker_stack_action == 'setup'
    - docker_stack_enable_selfsigned_certs
  include_tasks: setup-selfsigned-cert.yml

- name: "Setup ca certs"
  when:
    - docker_stack_action == 'setup'
    - docker_stack_enable_cacerts
  include_tasks: setup-cacerts.yml

- name: "Setup scripts"
  when:
    - docker_stack_action == 'setup'
    - docker_stack_setup_admin_scripts
  include_tasks: setup-scripts.yml

- name: "Setup docker app specific configs"
  block:

    - name: "Setup stepca certs"
      when:
        - docker_stack_action == 'setup'
        - __docker_stack_service_groups | intersect(['stepca']) | length>0
      vars:
        ansible_python_interpreter: "{{ docker_stack_python_docker_interpreter }}"
      include_tasks: setup-stepca.yml

    - name: "Setup registry"
      when:
        - docker_stack_action == 'setup'
        - docker_stack_setup_registry
      include_tasks: setup-registry.yml

#    - name: "Setup awx services"
#      when: "'awx' in __docker_stack_proxy_services"
#      include_tasks: setup-awx.yml

    - name: "Setup cobbler dirs and configs"
      when:
        - docker_stack_action == 'setup'
        - __docker_stack_service_groups | intersect(['cobbler']) | length>0
      include_tasks: setup-cobbler.yml

#######################
## the following plays utilize the `community.docker` modules
## the `community.docker` modules require the target host python interpreter environment to be configured
## with the docker python library.
##
## the docker python interpreter used in the following plays is specified by role variable 'docker_stack_python_docker_interpreter'
##
## the python interpreter environment and docker lib dependency is expected to be already prepared in a prior task
## by the 'bootstrap_pip' role
#######################
- name: "Setup docker stack services"
  when: docker_stack_action == 'setup'
  vars:
    ansible_python_interpreter: "{{ docker_stack_python_docker_interpreter }}"
  include_tasks: setup-service-configs.yml

- name: "{{ log_prefix_local }} Run compose action"
  vars:
    ansible_python_interpreter: "{{ docker_stack_python_docker_interpreter }}"
  include_tasks: run-compose-action.yml

- name: "{{ log_prefix_local }} Setup container configs"
  when:
    - docker_stack_action == 'setup'
    - __docker_stack_container_config_list|d([])|length > 0
  vars:
    ansible_python_interpreter: "{{ docker_stack_python_docker_interpreter }}"
  include_tasks: setup-container-configs.yml
  loop: "{{ __docker_stack_container_config_list }}"
  loop_control:
    loop_var: container_setup_info
