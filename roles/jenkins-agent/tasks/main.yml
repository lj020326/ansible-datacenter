---

- name: "Load OS distribution vars"
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution|lower() }}-{{ ansible_distribution_major_version|lower() }}.yml"
    - "{{ ansible_distribution|lower() }}.yml"
    - "{{ ansible_os_family|lower() }}.yml"
    - "default.yml"

- name: "Display primary role input variables"
  debug:
    msg:
      - "jenkins_agent__controller={{ jenkins_agent__controller }}"
      - "jenkins_agent__controller_url={{ jenkins_agent__controller_url }}"
      - "jenkins_agent__labels={{ jenkins_agent__labels }}"
      - "jenkins_agent__jenkins_user_groups={{ jenkins_agent__jenkins_user_groups }}"
      - "jenkins_agent__path={{ jenkins_agent__path }}"
      - "jenkins_agent__work_dir={{ jenkins_agent__work_dir }}"
      - "jenkins_agent__remoting_dir={{ jenkins_agent__remoting_dir }}"

- name: "Register agent node with Jenkins controller"
  when: jenkins_agent__register_with_controller|d(True)|bool
  delegate_to: localhost
  ansible.builtin.import_tasks: register_agent.yml

- name: "Running Jenkins Agent install tasks for {{ ansible_os_family|lower() }}"
  ansible.builtin.include_tasks: "{{ task_file }}"
  with_first_found:
    - "{{ ansible_distribution|lower() }}-{{ ansible_distribution_major_version|lower() }}.yml"
    - "{{ ansible_distribution|lower() }}.yml"
    - "{{ ansible_os_family|lower() }}.yml"
  loop_control:
    loop_var: task_file
