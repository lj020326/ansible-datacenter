---

- include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution }}.yml"
    - "{{ ansible_os_family }}.yml"
    - "default.yml"

- name: "Installing Packages required by webmin"
  package:
    name: "{{ webmin_packages }}"
    state: present

# It makes perl automatically answer "yes" when CPAN asks "Would you like to configure as much as possible automatically? [yes]"
- name: webmin | Install automatically perl module PERL_MM_USE_DEFAULT
  shell: "echo $PERL_MM_USE_DEFAULT"
  changed_when: no
  environment:
   PERL_MM_USE_DEFAULT: 1

- name: webmin | Echo PERL_MM_USE_DEFAULT again
  shell: "echo $PERL_MM_USE_DEFAULT"
  changed_when: no

- name: webmin | Check perl
  shell: perl -e 'use FileHandle; print $FileHandle::VERSION'
  changed_when: no
  become: true

- name: webmin | Install webmin
  include_tasks: "setup-webmin-{{ ansible_os_family }}.yml"

- name: webmin | Download and install webmin modules
  when: webmin_modules|d([])|length > 0
  block:

  - name: webmin | Display webmin_modules
    debug:
      var: webmin_modules

  - name: "update-reports-repo | Create temporary download directory"
    ansible.builtin.tempfile:
      state: directory
      suffix: ".webmin-module-downloads"
    register: __webmin_downloads_tempdir
    notify: "cleanup __webmin_downloads_tempdir"

  - name: webmin | Download webmin modules
    get_url:
      url: "{{ item.url }}"
      dest: "{{ __webmin_downloads_tempdir.path }}/{{ item.url|basename }}"
      validate_certs: false
    loop: "{{ webmin_modules }}"
    register: __webmin_modules_download_result

  - name: webmin | Display __webmin_modules_download_result
    debug:
      var: __webmin_modules_download_result

  ## ref: https://github.com/lj020326/ansible-datacenter/blob/main/docs/webmin/how-to-install-a-webmin-module-by-command-line-bash.md
  - name: webmin | Install webmin modules
    shell: "{{ webmin_base_dir }}/install-module.pl {{ __webmin_downloads_tempdir.path }}/{{ item.url|basename }}"
    loop: "{{ webmin_modules }}"
    register: __webmin_modules_install_result

  - name: webmin | Display __webmin_modules_install_result
    debug:
      var: __webmin_modules_install_result
