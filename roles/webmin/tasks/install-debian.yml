---

- name: webmin | Install webmin mandatory dependencies
  package:
    state: present
    name:
      - apt-transport-https
      - libapache2-mod-fcgid
      - webalizer
#      - webmin-virtualmin-git

- name: webmin | Initialize trust key type
  set_fact:
    __webmin_apt_repo_key_type: trust_store
    __webmin_repo_template: webmin.debian.repo.j2

## support for signed keys in repo config has been around since debian 9
## The "signed-by" repo option is available since Debian Stretch
## ref: https://github.com/ansible/ansible/issues/78063#issuecomment-1242970339
- name: webmin | Set trust key type
  when: (ansible_distribution=='Ubuntu' and ansible_distribution_major_version|int<=18) or
    (ansible_distribution=='Debian' and ansible_distribution_major_version|int<=9)
  set_fact:
    __webmin_apt_repo_key_type: apt_key
    __webmin_repo_template: webmin.debian.repo.jessie.j2

## ref: https://github.com/ansible/ansible/issues/78063
## ref: https://github.com/lj020326/ansible-datacenter/blob/main/docs/linux-package/ansible-how-to-fix-aptkey-deprecated-debianubuntu.md
- name: webmin | Add trusted apt repository key for webmin
  when: __webmin_apt_repo_key_type=='trust_store'
  ansible.builtin.get_url:
    url: "{{ webmin_repo_key_url }}"
    dest: "{{ webmin_apt_keyring_dir }}/webmin.asc"
    mode: '0644'
    force: true

- name: webmin | Add apt key for webmin
  when: __webmin_apt_repo_key_type=='apt_key'
  apt_key:
    url: "{{ webmin_repo_key_url }}"
    state: present

- name: webmin | Add Optional channel (Debian)
  template:
    src: "{{ __webmin_repo_template }}"
    dest: /etc/apt/sources.list.d/webmin.repo.list
    mode: "0644"

## ref: https://www.redpill-linpro.com/sysadvent/2017/12/24/ansible-system-updates.html
## ref: https://www.cyberciti.biz/faq/ansible-apt-update-all-packages-on-ubuntu-debian-linux/#:~:text=Upgrading%20all%20apt%20packages%20using%20Ansible&text=dist%20force_apt_get%3Dyes-,Where%2C,apt%2Dget%20instead%20of%20aptitude.
- name: webmin | Update apt-get repo and cache
  apt:
    update_cache: yes
    force_apt_get: yes

- name: webmin | Install webmin package
  package:
    name: webmin
    state: present
#    state: latest
#    update_cache: yes
#  changed_when: no

#- name: webmin | Remove duplicate entry.
##  when: ( ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu' )
#  when: ansible_os_family == 'Debian'
#  file: name=/etc/apt/sources.list.d/{{ item }} state=absent
#  become: true
#  with_items: webmin_repo_files
