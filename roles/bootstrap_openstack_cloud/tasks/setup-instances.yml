---
- name: start instances
  openstack.cloud.server:
    cloud: "{{ openstack_admin_cloud_name }}"
    name: "{{ item.name }}"
    auto_floating_ip: "{{ item.auto_floating_ip | d(omit) }}"
    flavor: "{{ item.flavor | d(omit) }}"
    image: "{{ item.image | d(omit) }}"
    key_name: "{{ item.key_name | d(omit) }}"
    nics: "{{ item.nics | d(omit) }}"
    security_groups: "{{ item.security_groups | d(omit) }}"
    meta: "{{ item.meta | d(omit) }}"
    userdata: "{{ item.userdata | d(omit) }}"
  loop: "{{ openstack_cloud_instances }}"
  register: os_instance_results

- name: Display os instance results
  ansible.builtin.debug:
    msg: "{{ os_instance_results }}"

- name: Display instanceâ€™s Floating IP
  ansible.builtin.debug:
    msg: "instance ({{ item.openstack.name }}): floating ip is {{ item.openstack.public_v4 }}"
  loop: "{{ os_instance_results.results }}"

- name: Assign public floating IP to instance
  openstack.cloud.floating_ip:
    cloud: "{{ openstack_admin_cloud_name }}"
    state: present
    server: "{{ item.0.name }}"
    network: "{{ item.1.network | d(omit) }}"
    nat_destination: "{{ item.1.nat_destination | d(omit) }}"
    wait: "{{ item.1.wait | d(true) }}"
    timeout: "{{ item.1.timeout | d(100) }}"
  loop: "{{ openstack_cloud_instances | subelements('ext_floating_ips', { 'skip_missing': true }) }}"
