---

- name: "Include OS-specific variables"
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution }}-{{ ansible_distribution_major_version}}.yml"
    - "{{ ansible_distribution }}.yml"
    - "{{ ansible_os_family }}.yml"
    - "default.yml"

- name: "Install pip env OS packages"
  package:
    state: present
    name: "{{ bootstrap_pip_packages }}"

## ref: https://pip.pypa.io/en/stable/topics/configuration/
- name: "Ensure /etc/pip.conf"
  copy:
    src: pip.conf
    dest: "/etc/pip.conf"
    mode: "0644"
    owner: "{{ ansible_user }}"
    backup: yes

#- name: "Create pip user config directory"
#  file:
#    path: "{{ bootstrap_pip_config_dir }}"
#    state: directory
#    mode: "0755"
#    owner: "{{ ansible_user }}"
#    group: "{{ ansible_user }}"
#
#- name: "Ensure {{ bootstrap_pip_config_dir }}//pip.conf"
#  copy:
#    src: pip.conf
#    dest: "{{ bootstrap_pip_config_dir }}/pip.conf"
#    mode: "0644"
#    owner: "{{ ansible_user }}"
#    backup: yes


- name: "Display bootstrap_pip_libs"
  debug:
    var: bootstrap_pip_libs

- name: "Set __bootstrap_pip_library_list_by_priority"
  set_fact:
    __bootstrap_pip_library_list_by_priority: "{{ __bootstrap_pip_library_list_by_priority | d({})
      | combine({ (item.priority | default(bootstrap_pip_lib_priority_default)|int): {
                    item.state | default(bootstrap_pip_lib_state): {
                        ((item is mapping) | ternary( item.name, item)): {}
                      }
                    }
                  }, recursive=True) }}"
  loop: "{{ bootstrap_pip_libs }}"

- name: "Install | Init-vars | Display __bootstrap_pip_library_list_by_priority"
  debug:
    var: __bootstrap_pip_library_list_by_priority

- name: "Install | Install pip libs"
  include_tasks: install-pip-libs.yml
  loop: "{{ bootstrap_pip_envs }}"
  loop_control:
    loop_var: pip_env
