---

- name: Ensure mount dirs exist
  when: __bootstrap_linux_mount_list is defined and __bootstrap_linux_mount_list|length > 0
  file:
    path: "{{ item.name }}"
    state: directory
  with_items: "{{ __bootstrap_linux_mount_list }}"

##
## For tmpfs Make sure to mount the tmpdir upon play handler since ansible is uses tmpdir
##
## ref: https://stackoverflow.com/questions/25977410/adding-an-fstab-option-using-ansible
## ref: https://medium.com/@rohansadale/mounting-and-un-mounting-a-volume-in-ansible-37ebf64e3334
##
- name: Add node mounts to fstab
  when:
    - __bootstrap_linux_mount_list|d([])|length > 0
    - not (item.fstype=='tmpfs' and item.name=='/tmp')
  mount:
    name: "{{ item.name }}"
    src: "{{ item.src }}"
    fstype: "{{ item.fstype }}"
    opts: "{{ item.options | d(omit) }}"
    state: "{{ item.state | d(bootstrap_linux_mount_state) }}"
  with_items: "{{ __bootstrap_linux_mount_list }}"
  register: mount_results
  failed_when: mount_results.failed and not ( mount_results.msg | regex_search("umount.* target is busy") )
  notify: mount-tmpdir
