---
##
## Remove roles
##

- name: "Remove roles"
  ansible.builtin.include_tasks: manage-roles.yml
  loop: "{{ controller_organizations }}"
  loop_control:
    loop_var: __organization_loop_var
    label: organization['name']

##
## Remove local users
##

- name: "Remove users"
  ansible.controller.user:
    username: "{{ item['username'] }}"
    organization: "{{ item['organization'] }}"
    state: absent
  loop: "{{ bootstrap_ansible_controller__local_users }}"

##
## Remove teams
##

- name: Remove teams
  block:
    - name: Remove team
      ansible.controller.team:
        name: "{{ item['team'] }}"
        organization: "{{ item['organization'] }}"
        state: absent
      register: remove_team_result
      ignore_errors: "{{ ansible_check_mode }}"
      loop: "{{ __org_team_list }}"
      loop_control:
        label: "{{ item['organization'] }} - {{ item['team'] }}"
  rescue:
    - name: Rescue if failure is due to resources already absent
      ansible.builtin.assert:
        that: "'returned 0 items' in item.msg"
        quiet: true
      loop: "{{ remove_team_result['results'] | selectattr('failed') }}"
      loop_control:
        label: "{{ item['item']['organization'] }} - {{ item['item']['team'] }}"

##
## Remove schedules
##

- name: Remove schedules
  block:
    - name: Remove schedules
      ansible.builtin.include_tasks: manage-schedules.yml
      loop: "{{ __controller_schedules }}"
      loop_control:
        loop_var: __schedule_loop_var
        label: "{{ __schedule_loop_var['schedule_name'] }}"
      when:
        - __controller_schedules | d([]) | length>0
        - __schedule_loop_var['environments'] is not defined or controller_env.lower() in __schedule_loop_var['environments']

##
## Remove workflow templates
##

- name: Workflow template block
  when: controller_workflow_templates | d([]) | length>0
  block:
    - name: Remove workflow template
      ansible.controller.workflow_job_template:
        name: "{{ item['name'] }}"
        state: absent
      loop: "{{ controller_workflow_templates }}"

##
## Remove job templates
##

- name: Remove job templates
  when: __controller_job_templates | d([]) | length>0
  block:
    - name: Remove job templates
      ansible.controller.job_template:
        name: "{{ item['name'] }}"
        organization: "{{ item['organization'] | d(omit) }}"
        state: absent
      register: remove_job_template_result
      ignore_errors: "{{ ansible_check_mode }}"
      loop: "{{ __controller_job_templates }}"
      loop_control:
        label: "{{ item['organization'] }} - {{ item['name'] }}"
  rescue:
    - name: Rescue if failure is due to resources already absent
      ansible.builtin.assert:
        that: "'returned 0 items' in item.msg"
        quiet: true
      loop: "{{ remove_job_template_result['results'] | selectattr('failed') }}"
      loop_control:
        label: "{{ item['item']['organization'] }} - {{ item['item']['name'] }}"

##
## Remove inventories
##

- name: Remove inventories
  when: __controller_inventories | d([]) | length>0
  block:
    - name: Remove inventory
      ansible.controller.inventory:
        name: "{{ item['name'] }}"
        organization: "{{ item['organization'] }}"
        state: absent
      register: remove_inventory_result
      loop: "{{ __controller_inventories }}"
      loop_control:
        label: "{{ item['organization'] }} - {{ item['name'] }}"
  rescue:
    - name: Rescue if failure is due to resources already absent
      ansible.builtin.assert:
        that: "'returned 0 items' in item.msg"
        quiet: true
      loop: "{{ remove_inventory_result['results'] | selectattr('failed') }}"
      loop_control:
        label: "{{ item['item']['organization'] }} - {{ item['item']['name'] }}"

##
## Remove projects
##

- name: Remove projects
  when: controller_projects | d([]) | length>0
  block:
    - name: Remove project
      ansible.controller.project:
        name: "{{ item['name'] }}"
        organization: "{{ item['organization'] }}"
        state: absent
      register: remove_project_result
      loop: "{{ __controller_projects }}"
      loop_control:
        label: "{{ item['organization'] }} - {{ item['name'] }}"
  rescue:
    - name: Rescue if failure is due to resources already absent
      ansible.builtin.assert:
        that: "'returned 0 items' in item.msg"
        quiet: true
      loop: "{{ remove_project_result['results'] | selectattr('failed') }}"
      loop_control:
        label: "{{ item['item']['organization'] }} - {{ item['item']['name'] }}"


##
## Remove credentials
##

- name: Remove credentials
  when: controller_credentials | d([]) | length > 0
  block:
    - name: Remove credential
      ansible.controller.credential:
        name: "{{ item['name'] }}"
        organization: "{{ item['organization'] }}"
        credential_type: "{{ item['credential_type'] }}"
        state: absent
      register: remove_credential_result
      loop: "{{ controller_credentials }}"
      loop_control:
        label: "{{ item['organization'] }} - {{ item['name'] }}"
  rescue:
    - name: Rescue if failure is due to resources already absent
      ansible.builtin.assert:
        that: "'returned 0 items' in item.msg"
        quiet: true
      loop: "{{ remove_credential_result['results'] | selectattr('failed') }}"
      loop_control:
        label: "{{ item['item']['organization'] }} - {{ item['item']['name'] }}"

- name: Remove credential types
  when: controller_credential_types | d([]) | length > 0
  ansible.controller.credential_type:
    name: "{{ item['name'] }}"
    state: absent
  register: remove_credential_type_result
  loop: "{{ controller_credential_types }}"
  loop_control:
    label: "{{ item['name'] }}"

##
## Remove custom execution environments
##

- name: Execution environments block
  block:
    - name: Add custom execution environments
      ansible.controller.execution_environment:
        name: "{{item['name'] }}"
        image: "{{ item['image'] }}"
        credential: "{{ item['credential'] }}"
        state: absent
      loop: "{{ controller_execution_environments }}"

##
## Remove organizations
##

- name: Remove organizations
  ansible.controller.organization:
    name: "{{ item.name }}"
    state: absent
  loop: "{{ controller_organizations }}"
  loop_control:
    label: "{{ item['name'] }}"
