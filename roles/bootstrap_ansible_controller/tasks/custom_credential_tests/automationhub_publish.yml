---
### Validation for custom credential type:
### 'automationhub publish'
### Performs an API GET on provided URL

- name: Automationhub publish credential type validations
  block:
    - name: Connect to private hub api endpoint
      ansible.builtin.uri:
        url: "{{ item['inputs']['url'] }}"
        method: GET
        headers:
          Authorization: "Token {{ item['inputs']['apikey'] }}"
      register: __automationhub_publish_results
      check_mode: false
      no_log: true # Hide api key from high verbosity output
      loop: "{{ controller_credentials | selectattr('credential_type', 'eq', 'automationhub publish') }}"
      loop_control:
        label: "{{ item['name'] }}"
  rescue:
    - name: Set test failure flag to true
      ansible.builtin.set_fact:
        __credential_test_failures: true

    - name: Display failure details
      ansible.builtin.debug:
        msg: "{{ __automationhub_publish_results['results'] | selectattr('failed') }}"
