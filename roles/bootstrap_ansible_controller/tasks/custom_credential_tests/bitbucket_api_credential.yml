---
### Validation for custom credential type:
### 'automationhub publish'
### Attempts to retrieve a list of branches in provided project/repo via API GET

- name: Bitbucket API credential credential type validations
  block:
    - name: Get list of branches in repository
      no_log: true
      ansible.builtin.uri:
        url: "{{ item['inputs']['bitbucket_api_url'] }}/rest/api/latest/projects/{{ item['inputs']['bitbucket_api_project'] }}\
          /repos/{{ item['inputs']['bitbucket_api_repo'] }}/branches"
        validate_certs: "{{ item['inputs']['bitbucket_api_validate_certs'] }}"
        url_username: "{{ item['inputs']['bitbucket_api_username'] }}"
        url_password: "{{ item['inputs']['bitbucket_api_token'] }}"
        method: GET
        force_basic_auth: true
        headers:
          Accept: application/json
          Content-Type: application/json
      register: __bitbucket_api_results
      check_mode: false
      loop: "{{ controller_credentials | selectattr('credential_type', 'eq', 'Bitbucket API credential') }}"
      loop_control:
        label: "{{ item['name'] }}"
  rescue:
    - name: Set test failure flag to true
      ansible.builtin.set_fact:
        __credential_test_failures: true

    - name: Display failure details
      ansible.builtin.debug:
        msg: "{{ __bitbucket_api_results['results'] | selectattr('failed') }}"
