---
### Validation for custom credential type:
### 'cyberark_credential'
### Performs an authentication via aap_common.util.cyberark_authentication module

- name: Cyberark_credential credential type validations
  block:
    - name: Login to cyberark
      dettonville.cyberark.get_accounts:
        validate_certs: false
        safe: "A-T-Ansible"
        filter_search_string: "administrator"
        api_base_url: "{{ item['inputs']['cyberark_base_url'] }}"
        api_username: "{{ item['inputs']['cyberark_username'] }}"
        api_password: "{{ item['inputs']['cyberark_password'] }}"
      no_log: true # Hide password from high verbosity output
      register: __cyberark_credential_results
      loop: "{{ controller_credentials | selectattr('credential_type', 'eq', 'cyberark_credential') }}"
      loop_control:
        label: "{{ item['name'] }}"
  rescue:
    - name: Set test failure flag to true
      ansible.builtin.set_fact:
        __credential_test_failures: true

    - name: Display failure details
      ansible.builtin.debug:
        msg: "{{ __cyberark_credential_results['results'] | selectattr('failed') }}"
