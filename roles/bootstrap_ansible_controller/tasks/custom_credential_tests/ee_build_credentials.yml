---
### Validation for custom credential type:
### 'EE Build Credentials'
### Performs an podman_login to both RedHat and private Automation Hub registries

- name: EE Build Credentials credential type validations
  block:
    - name: Login to RedHat registry
      no_log: true
      containers.podman.podman_login:
        username: "{{ item['inputs']['redhat_registry_username'] }}"
        password: "{{ item['inputs']['redhat_registry_password'] }}"
        registry: "{{ item['inputs']['redhat_registry_url'] }}"
      delegate_to: ansutil01.s4.dettonville.int
      register: __redhat_registry_login_result
      loop: "{{ controller_credentials | selectattr('credential_type', 'eq', 'EE Build Credentials') }}"
      loop_control:
        label: "{{ item['name'] }}"

    - name: Login to private automation hub
      no_log: true
      containers.podman.podman_login:
        username: "{{ item['inputs']['private_hub_username'] }}"
        password: "{{ item['inputs']['private_hub_password'] }}"
        registry: "{{ item['inputs']['private_hub_url'] }}"
      delegate_to: ansutil01.s4.dettonville.int
      register: __private_hub_login_result
      loop: "{{ controller_credentials | selectattr('credential_type', 'eq', 'EE Build Credentials') }}"
      loop_control:
        label: "{{ item['name'] }}"
  rescue:
    - name: Set test failure flag to true
      ansible.builtin.set_fact:
        __credential_test_failures: true

    - name: Display RedHat registry failure details
      ansible.builtin.debug:
        msg: "{{ __redhat_registry_login_result['results'] | d([]) | selectattr('failed') }}"

    - name: Display private hub failure details
      ansible.builtin.debug:
        msg: "{{ __private_hub_login_result['results'] | d([]) | selectattr('failed') }}"
