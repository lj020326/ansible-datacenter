---
### Validation for custom credential type:
### 'ControlM Login'
### Performs a login via API POST to provided URL

- name: ControlM Login credential type validations
  block:
    - name: Get controlm authorization token
      ansible.builtin.uri:
        url: "https://conmp2.s4.dettonville.int/automation-api/session/login" # TODO: Add URL to controlm credential
        validate_certs: false
        method: POST
        body_format: json
        body:
          username: "{{ item['inputs']['controlm_user'] }}"
          password: "{{ item['inputs']['controlm_password'] }}"
        return_content: true
      no_log: true # Hide password from high verbosity output
      register: __controlm_login_results
      check_mode: false
      loop: "{{ controller_credentials | selectattr('credential_type', 'eq', 'ControlM Login') }}"
      loop_control:
        label: "{{ item['name'] }}"
  rescue:
    - name: Set test failure flag to true
      ansible.builtin.set_fact:
        __credential_test_failures: true

    - name: Display failure details
      ansible.builtin.debug:
        msg: "{{ __controlm_login_results['results'] | selectattr('failed') }}"
