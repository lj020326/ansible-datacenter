---
- name: Unmask credentials
  ansible.builtin.set_fact:
    vaulted_credentials: "{{ _vaulted_credentials }}"
  no_log: true

- name: Set test failure flag to false
  ansible.builtin.set_fact:
    __credential_test_failures: false

# Run custom credential tests
- name: Include tasks files
  ansible.builtin.include_tasks: "{{ test_file_name }}"
  with_fileglob:
    - "custom_credential_tests/*.yml"
    - "custom_credential_tests/*.yaml"
  loop_control:
    loop_var: test_file_name
    label: "{{ test_file_name }}"

##
## Domain Join
## TODO: Cannot loop with vars, which is necessary for delegating to windows. Solution needed.

##
## git deploy key
## (TODO: credentials not linked to endpoints)

##
## git EE build key
## (TODO: credentials not linked to endpoints)

##
## MSSQLv2
## (TODO: credentials not linked to endpoints)

##
## SentinelOne Site Token
## (TODO: SentinelOne installation not working, see INFRA-1354)

##
## tower api access
## (TODO: Deprecated, replace with controller api access credentials)

##
## VMWARE Template
##

##
## Service Account
## (TODO: credentials not linked to endpoints)

##
## SQL SERVER connection
## (TODO: credentials not linked to endpoints)

##
## openshift_prod_auth_4
## (TODO: credentials not linked to endpoints)

##
## openshift_np_auth_4
## (TODO: credentials not linked to endpoints)

##
## openshift_aws_auth_4
## (TODO: credentials not linked to endpoints)

##
## DB - MSSQL Master Keys
## (TODO: credentials not linked to endpoints)

##
## Trendmicro DSA
## (TODO: credentials not linked to endpoints)

##
## Tableau
## (TODO: credentials not linked to endpoints)

##
## Unica DB Credential
## (TODO: credentials not linked to endpoints)

##
## F5_Credentials
## (TODO: credentials not linked to endpoints)

##
## NTW-Meraki
## (TODO: credentials not linked to endpoints)

##
## panos - palo alto
## (TODO: credentials not linked to endpoints)

- name: Mask credentials
  ansible.builtin.set_fact:
    vaulted_credentials: "{{ vaulted_credentials | d({}) | combine(({item: 'MASKED'})) }}"
  loop: "{{ _vaulted_credentials.keys() | list }}"

- name: End play if any credential validations failed
  ansible.builtin.fail:
    msg: Some credential validations failed. Resolve issues before relaunching.
  when: __credential_test_failures
