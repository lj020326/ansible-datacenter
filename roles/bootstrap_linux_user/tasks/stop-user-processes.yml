---
- name: Stop-user-processes | Get running user processes for {{ current_user.name }}
  when: current_user.name is defined
  ansible.builtin.shell: "ps -u {{ current_user.name }} -o pid= || true"
  changed_when: false
  register: __user_processes

- name: Stop-user-processes | Kill processes for {{ current_user.name }}
  when: __user_processes.stdout | d('') | length > 0
  changed_when: true
  ansible.builtin.command: "kill -9 {{ item }}"
  loop: "{{ __user_processes.stdout.split() }}"
  register: __kill_result
  failed_when: __kill_result is failed and not ( __kill_result.stderr | regex_search("No such process") )
