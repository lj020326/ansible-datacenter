---

## ref: https://stackoverflow.com/questions/38847824/ansible-how-to-get-service-status-by-ansible
- name: Get Service Status for tmp.mount service
  ignore_errors: yes
  ansible.builtin.systemd:
    name: "tmp.mount"
  register: __service_status_tmp_mount

## Disable systemd tmp.mount - can cause issues during ansible linux bootstrap role
- name: Disable service tmp.mount and ensure it is masked during play
  when: __service_status_tmp_mount.status.ActiveState=="active"
  notify: reenable-tmp.mount
  ansible.builtin.systemd:
    name: tmp.mount
    enabled: no
    masked: yes

#- name: "Setup cloud-init"
#  include_role:
#    name: bootstrap-cloud-init
#  tags:
#    - bootstrap-linux-core
#    - bootstrap-linux-nocerts
#    - bootstrap-cloudinit

- name: "Bootstrap linux users"
  include_role:
    name: bootstrap-linux-user
  tags:
    - bootstrap-linux-core
    - bootstrap-linux-nocerts
    - bootstrap-linux-user
    - bootstrap-user

- name: "Bootstrap linux packages"
  when: bootstrap_linux_install_packages|d(True)|bool
  include_role:
    name: bootstrap-linux-package
  tags:
    - bootstrap-linux-core
    - bootstrap-linux-nocerts
    - bootstrap-linux-package
    - bootstrap-package

- name: "Bootstrap linux mounts"
  include_role:
    name: bootstrap-linux-mount
  tags:
    - bootstrap-linux-core
    - bootstrap-linux-nocerts
    - bootstrap-linux-mount
    - bootstrap-mount

- name: "Bootstrap linux core features (environment, dns, hostname, mounts, backups, timezone, journald, motd, etc)"
  include_role:
    name: bootstrap-linux-core
  tags:
    - bootstrap-linux-core
    - bootstrap-linux-nocerts

- name: "Setup vmware-tools"
  include_role:
    name: vmware-tools
  when: bootstrap_linux_install_vmware_tools|d(True)|bool
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-vmtools

- name: "Setup bootstrap-ntp"
  when: bootstrap_linux_install_ntp|d(True)|bool
  include_role:
    name: bootstrap-ntp
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-ntp

- name: "Bootstrap postfix"
  when: bootstrap_linux_setup_postfix|d(True)|bool
  include_role:
    name: bootstrap-postfix
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-postfix

- name: "Install/Setup linux firewalld"
  when: bootstrap_linux_setup_firewalld|d(True)|bool
  include_role:
    name: bootstrap-linux-firewalld
  vars:
    firewalld_action: install
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-firewalld

- name: "Bootstrap pip"
  include_role:
    name: bootstrap-pip
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-pip

- name: "Bootstrap java"
  when: bootstrap_linux_setup_java|d(True)|bool
  include_role:
    name: bootstrap-java
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-java

## ref: ## https://www.ssh.com/ssh/sshd_config/
- name: "Setup sshd"
  when: bootstrap_linux_setup_sshd|d(True)|bool
  include_role:
    name: bootstrap-sshd
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-sshd

- name: "Setup ldap-client"
  when: bootstrap_linux_setup_ldap_client|d(True)|bool
  include_role:
    name: ldap-client
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-ldap-client

- name: "Setup logrotate"
  when: bootstrap_linux_setup_logrotate|d(True)|bool
  include_role:
    name: ansible-logrotate
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-logrotate

- name: "Bootstrap nfs service"
  when: bootstrap_linux_setup_nfs|d(True)|bool
  include_role:
    name: bootstrap-nfs-service
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-nfs

- name: "Setup samba-client"
  when: bootstrap_linux_setup_samba_client|d(True)|bool
  include_role:
    name: samba-client
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-samba
    - samba-client

- name: "Setup webmin"
  when: bootstrap_linux_setup_webmin|d(True)|bool
  include_role:
    name: bootstrap-webmin
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-webmin

- name: "Setup docker"
  when: bootstrap_linux_setup_docker|d(True)|bool
  block:
  - name: "Setup pip"
    include_role:
      name: bootstrap-pip

  - name: "Setup docker"
    include_role:
      name: bootstrap-linux-docker

- name: "Setup network"
  when: bootstrap_linux_setup_network|d(True)|bool
  include_role:
    name: bootstrap-linux-networking
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-network

#- name: "Setup bootstrap-linux-caroot"
#  when: bootstrap_linux_setup_caroot|d(False)|bool
#  include_role:
#    name: bootstrap-linux-caroot
#  tags:
#    - bootstrap-linux-core
#    - bootstrap-caroot

- name: "Setup ansible-role-stepca"
  when: bootstrap_linux_setup_stepca|d(True)|bool
  include_role:
    name: ansible-role-stepca
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-stepcli

- name: "Run deploy-cacerts"
  when: bootstrap_linux_setup_cacerts|d(True)|bool
  include_role:
    name: deploy-cacerts

- name: "Setup ansible-harden-linux"
  when: bootstrap_linux_harden|d(True)|bool
  include_role:
    name: ansible-harden-linux
  tags:
    - bootstrap-linux-nocerts
    - bootstrap-secure
