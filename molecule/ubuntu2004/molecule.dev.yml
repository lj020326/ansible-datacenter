---
dependency:
  name: galaxy
  options:
    ignore-certs: True
    ignore-errors: True
    role-file: roles/requirements.yml
    requirements-file: collections/requirements.yml
driver:
  name: docker
lint: |
  yamllint .
  ansible-lint
  flake8

## ref: https://molecule.readthedocs.io/en/stable/configuration.html#platforms
## ref: https://github.com/robertdebock/ansible-role-python_pip/blob/master/molecule/default/molecule.yml
## ref: https://github.com/marketplace/actions/test-ansible-roles-with-molecule
platforms:
  - name: ubuntu2004
    registry:
      url: media.johnson.int:5000
      credentials:
        username: "${DOCKER_REGISTRY_USERNAME:-admin}"
        password: "${DOCKER_REGISTRY_PASSWORD:-password}"
    image: "${MOLECULE_IMAGE_NAMESPACE:-lj020326}/${MOLECULE_DISTRO:-ubuntu2004}-systemd-python:${MOLECULE_IMAGE_TAG:-latest}"
    privileged: true
#    command: /lib/systemd/systemd
    # tmpfs:
    #   - /run
    #   - /tmp
    capabilities:
      - SYS_ADMIN
      - NET_ADMIN
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
    privileged: true
    pre_build_image: true
    groups:
      - molecule_docker_linux

## ref: https://molecule.readthedocs.io/en/latest/configuration.html?highlight=provisioner#molecule.provisioner.ansible.Ansible
provisioner:
  name: ansible
  options:
    vvv: true
  playbooks:
    prepare: ../shared/prepare.yml
    converge: ${MOLECULE_PLAYBOOK:-../shared/converge.yml}
  inventory:
    links:
      group_vars: ../../inventory/group_vars
  config_options:
    defaults:
      remote_tmp: /tmp/.ansible
  env:
    ANSIBLE_COLLECTIONS_PATH: "~/.ansible/collections"
verifier:
  name: ansible
