---
- name: Set __relative_role_path for role
  ansible.builtin.set_fact:
    __relative_role_path: ../../../roles/bootstrap_postfix

- name: Include role variables.
  ansible.builtin.include_vars: "{{ __relative_role_path }}/defaults/main.yml"

- name: Include role OS-specific variables.
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ __relative_role_path }}/vars/{{ ansible_facts['distribution'] | lower }}-{{ ansible_facts['distribution_major_version'] }}.yml"
        - "{{ __relative_role_path }}/vars/{{ ansible_facts['distribution'] | lower }}.yml"
        - "{{ __relative_role_path }}/vars/{{ ansible_facts['os_family'] | lower }}.yml"
        - "{{ __relative_role_path }}/vars/default.yml"
      skip: true

- name: Display bootstrap_postfix__service_packages
  ansible.builtin.debug:
    var: bootstrap_postfix__service_packages

- name: Check postfix package status
  ansible.builtin.package:
    name: "{{ bootstrap_postfix__service_packages }}"
    state: present
  check_mode: true
  register: pkg_status_postfix

- name: Display pkg_status_postfix
  ansible.builtin.debug:
    var: pkg_status_postfix

- name: Check postfix packages are installed
  ansible.builtin.assert:
    that:
      - not pkg_status_postfix.changed

- name: Assert postfix service is installed/running
  ansible.builtin.assert:
    that: ansible_facts['services']
      | intersect([bootstrap_postfix__service_name, bootstrap_postfix__service_name+'.service']) | d([]) | length > 0
