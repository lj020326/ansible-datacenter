---
#ansible_user: ansible
#ansible_admin_user: "{{ lookup('env', 'USER') }}"

#python_target_dist: "3.7"
#python_major_version: "{{ python_target_dist.split('.')[0] }}"
#
##python_dists:
##  - version: 3.6
###    major_version: 3
##  - version: 2.7
###    major_version: 2

#ipv4_net_prefix: 16
#ipv4_net_prefix: 8

bootstrap_linux_dns_domain: "{{ dns_domain }}"
bootstrap_linux_dns_search_domains: "{{ dns_search_domains }}"
bootstrap_linux_hostname_internal_domain: "{{ internal_domain }}"
bootstrap_linux_hostname_name_full: "{{ inventory_hostname_short }}.{{ hostname_internal_domain }}"
bootstrap_linux_hostname_name_short: "{{ inventory_hostname_short }}"

pki_cert_dir: /etc/ssl/certs
pki_key_dir: /etc/ssl/private

ca_local_cert_dir: /usr/local/ssl/certs
ca_local_key_dir: /usr/local/ssl/private

vmware_vm_gateway_ip: "{{ gateway_ip4 }}"

## OS VM provisioned user used to initially bootstrap OS admin users
#bootstrap_user: root
#bootstrap_user: administrator
bootstrap_user: packer

bootstrap_linux_ansible_username: "{{ ansible_user }}"
#bootstrap_linux_ansible_authorized_public_sshkey: "{{ '~/.ssh/id_rsa.pub' | expanduser }}"
bootstrap_linux_ansible_authorized_public_sshkey: "{{ ansible_ssh_public_key }}"

os_python2_interpreter: "/usr/bin/python2"
os_python3_interpreter: "/usr/bin/python3"
os_pip2_bin: "/usr/bin/pip2"
os_pip3_bin: "/usr/bin/pip3"

os_python_interpreter: "{{ os_python3_interpreter }}"
os_pip_bin: "{{ os_pip3_bin }}"

ansible_python_interpreter: "{{ os_python_interpreter }}"
ansible_pip_interpreter: "{{ os_pip_bin }}"

### https://github.com/nickjj/ansible-docker
#ansible_python_docker_interpreter: "/usr/bin/env python-docker"
ansible_python_docker_interpreter: "/usr/local/bin/python-docker"

openstack_venv_path: "/opt/openstack"
ansible_openstack_python_interpreter: "{{ openstack_venv_path  }}/bin/python"

ca_keyring_repo_email: "ansible@dettonville.org"

#harden_linux_os_auditd_max_log_file_action: keep_logs
harden_linux_os_auditd_max_log_file_action: rotate

logrotate_applications:
  - name: audit
    definitions:
      - logs:
          - "/var/log/audit/*.log"
        options:
#          - su user group
          - rotate 4
          - daily
#          - weekly
          - missingok
          - notifempty
  - name: mail
    definitions:
      - logs:
        -  "/var/log/mail.*"
        options:
          - daily
          - size 25M
          - rotate 4
          - missingok
          - compress
          - delaycompress
          - copytruncate


timezone: "America/New_York"

## ansible-harden-linux
#harden_linux_os_login_defs_enabled: yes
#harden_linux_cron_enabled: yes
#harden_linux_os_auditd_enabled: yes
#harden_linux_sysctl_enabled: yes

#harden_linux_os_auth_pw_max_age: 99999
#harden_linux_os_auth_pw_min_age: 0

## firewall
firewalld_enabled: yes
firewalld_default_zone: internal

firewalld_conf:
  DefaultZone: "{{ firewalld_default_zone }}"
  ## ref: https://github.com/firewalld/firewalld/issues/440
  IndividualCalls: "yes"

firewalld_services:
  - name: ssh
  - name: ntp
  - name: webmin
    short: "webmin"
    custom: yes
    description: "webmin services"
    port:
      - port: 10000
        protocol: tcp

firewalld:
  - zone: "{{ firewalld_default_zone }}"
    immediate: 'yes'
    masquerade: 'yes'
    permanent: 'yes'
    state: enabled

firewalld_zones:
  - name: "{{ firewalld_default_zone }}"
    short: "MGT"
    description: "internal infrastructure hosts"
    target: "ACCEPT"
    source:
      ## localhost
      - address: 127.0.0.0/8
      ## docker
      - address: 172.0.0.0/8
      ## internal networks
      - address: "{{ gateway_ip4_subnet_1_2 }}.0.0/{{ ipv4_net_prefix }}"
    service:
      - name: "webmin"
      - name: ssh

## NTP client settings moved to groups/ntp_client.yml
### NTP configs
### ref: https://github.com/geerlingguy/ansible-role-ntp
#ntp_enabled: true
#ntp_timezone: America/New_York
#
#ntp_manage_config: yes
#ntp_area: 'us'
#
#ntp_servers:
#  - "192.168.0.1 prefer iburst"
#
#ntp_servers:
#  - "192.168.0.1 iburst"
#  - 0{{ '.' + ntp_area if ntp_area else '' }}.pool.ntp.org iburst
#  - 1{{ '.' + ntp_area if ntp_area else '' }}.pool.ntp.org iburst
#  - 2{{ '.' + ntp_area if ntp_area else '' }}.pool.ntp.org iburst
#  - 3{{ '.' + ntp_area if ntp_area else '' }}.pool.ntp.org iburst

## postfix client settings moved to groups/postfix_client.yml
### BOOTSTRAP-NODE
### POSTFIX
#postfix_aliases:
#  - user: hostmaster
#    alias: root
##  - user: root
##    alias: admin@dettonville.org
#  - user: root
#    alias: admin@dettonville.com
#
#postfix_virtual_aliases:
##  - virtual: root
##    alias: admin@dettonville.org
#  - virtual: root
#    alias: admin@dettonville.com
#
#postfix_sender_canonical_maps:
##  - sender: root
##    rewrite: admin@dettonville.org
#  - sender: root
#    rewrite: admin@dettonville.com
#
#postfix_relayhost: mail.johnson.int
#postfix_relayhost_port: 25
#postfix_sasl_auth_enable: false
#postfix_smtpd_use_tls: false
#postfix_inet_protocols: ipv4
#
#postfix_disable_vrfy_command: true
#
##postfix_mailname: "dettonville.org"
##postfix_mydestination: []
#postfix_mydestination:
#  - "{{ postfix_hostname }}"
#  - localdomain
#  - localhost
#  - localhost.localdomain
#
#postfix_mynetworks:
#  - 127.0.0.0/8
#  - 172.0.0.0/8
#  - 10.0.0.0/8
#  - 192.168.0.0/16
#  - 'localhost'
#  - '[::ffff:127.0.0.0]/104'
#  - '[::1]/128'
#
#postfix_sasl_user: AKIXXXXXXXXXXXXXXXXX
#postfix_sasl_password: ASDFXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
#
##postfix_smtpd_relay_restrictions: []
#
#postfix_raw_options:
# - |
#   #debug_peer_list = 192.168.0.135, 192.168.0.43, 192.168.0.40
#   #debug_peer_list = 192.168.0.42
#   debug_peer_list = 192.168.0.15
#

## SSHD configs
## https://www.ssh.com/ssh/sshd_config/
## https://github.com/willshersystems/ansible-sshd
## https://gist.github.com/cmavr8/eb4a9e596bd0e3e85f97d907de288c54
## https://www.veeam.com/kb2061
## https://gist.github.com/cmavr8/eb4a9e596bd0e3e85f97d907de288c54
sshd:
  AcceptEnv: LANG LC_*
  AuthorizedKeysFile: .ssh/authorized_keys
  ChallengeResponseAuthentication: no
  Ciphers: aes256-gcm@openssh.com,aes128-ctr,aes192-ctr,aes256-ctr
  GSSAPIAuthentication: yes
  GSSAPICleanupCredentials: no
  KexAlgorithms: curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,diffie-hellman-group14-sha256,diffie-hellman-group-exchange-sha256,diffie-hellman-group1-sha1
  MACs: hmac-sha2-256,hmac-sha2-512,hmac-sha1
  PasswordAuthentication: yes
#  Banner: /etc/issue
  PrintMotd: no
  Subsystem: "sftp {{ '/usr/libexec/openssh/sftp-server' if ansible_os_family=='RedHat' else '/usr/lib/openssh/sftp-server' }}"
  SyslogFacility: AUTHPRIV
  UseDNS: no
  UsePAM: yes
  UsePrivilegeSeparation: sandbox
  X11Forwarding: yes

  ## use LDAP ssh public key
  ## ref: http://pig.made-it.com/ldap-openssh.html#29273
  AuthorizedKeysCommand: /usr/local/bin/fetchSSHKeysFromLDAP
  AuthorizedKeysCommandUser: nobody
#  AuthorizedKeysCommandRunAs root


bootstrap_linux_node_mounts_tmpdir:
  - name: "/tmp"
    src: "tmpfs"
    fstype: "tmpfs"
    options: 'size=512m,defaults,noatime,nosuid,nodev,mode=1777'
#    options: 'size=2G,defaults,noatime,nosuid,nodev,mode=1777'

bootstrap_linux_node_mounts:
  - name: "/data"
    src: "diskstation01.johnson.int:/volume1/data"
    fstype: "nfs"
    options: "intr,auto,_netdev"

#  - name: "/data"
##    src: "control01.johnson.int:/srv/data1/data"
#    src: "control01.johnson.int:/data"
#    fstype: "nfs"
#    options: "intr,_netdev"
#
#  - name: "/mnt/syn-ds01"
#    src: "diskstation01.johnson.int:/volume1/data"
#    fstype: "nfs"
#    options: "intr,_netdev"
#
#  - name: "/data"
#    src: "/mnt/syn-ds01"
#    fstype: none
#    options: "rw,bind"


container_user_name: "container-user"
container_user_uid: 1102
container_user_gid: 1102

sha512_hashed_root_password: "00000000000000000000000000000000000000000"
sha512_hashed_admin_password: "00000000000000000000000000000000000000000"

bootstrap_linux_root_user:
  name: root
  homedir: /root
  hashed_password: "{{ sha512_hashed_root_password }}"
  generate_ssh_key: no
#  ssh_keypair:
#    private: '{{ admin_ssh_private_key }}'
#    public: '{{ admin_ssh_public_key }}'

bootstrap_linux_users:

  ## ref: https://unix.stackexchange.com/questions/343445/user-id-less-than-1000-on-centos-7
  - name: administrator
    system: yes
    groups: "{{ bootstrap_linux_user_admin_sudo_group }}"
    generate_ssh_key: no
#    generate_ssh_key: yes
    ssh_keypair:
      private: "{{ admin_ssh_private_key }}"
      public: "{{ admin_ssh_public_key }}"
    auth_key: "{{ admin_ssh_public_key }}"
    hashed_password: "{{ sha512_hashed_admin_password }}"
    uid: 400
    gid: 400
    password_valid_days: 99999

  - name: ansible
    system: yes
    groups: "{{ bootstrap_linux_user_admin_sudo_group }}"
    generate_ssh_key: no
    ssh_keypair:
      private: "{{ ansible_ssh_private_key }}"
      public: "{{ ansible_ssh_public_key }}"
    ## How to use Credentials in AWX playbook
    ## Using custom credential to store public ssh keys (for now)
    ## ref: https://groups.google.com/forum/#!topic/awx-project/ce95ooS2sp0
    ## ref: https://termlen0.github.io/2019/06/08/observations/
    auth_key: "{{ admin_ssh_public_key }}"
    hashed_password: "{{ sha512_hashed_ansible_password }}"
    uid: 401
    gid: 401
    password_valid_days: 99999

  - name: "{{ container_user_name }}"
    hashed_password: "{{ sha512_hashed_admin_password }}"
    uid: "{{ container_user_uid }}"
    gid: "{{ container_user_gid }}"


harden_linux_sysctl_overwrite:
  ## if docker/k8s, enable ipv4 forwarding
  # Enable IPv4 traffic forwarding.
  net.ipv4.ip_forward: 1

  ## ref: https://bbs.archlinux.org/viewtopic.php?id=141144
#  net.ipv6.ip_forward: 0

  ## ref: https://wwwx.cs.unc.edu/~sparkst/howto/network_tuning.php
  net.core.rmem_default: 65536
  net.core.wmem_default: 65536

  ## ref: https://www.cyberciti.biz/faq/linux-tcp-tuning/
  ##  The default value of rmem_max and wmem_max is about 128 KB in most Linux distributions,
  ##  which may be enough for a low-latency general purpose network environment or for apps such as DNS / Web server.
  ##  However, if the latency is large, the default size might be too small.
  ## Please note that the following settings going to increase memory usage on your server.
#  net.core.rmem_max: 8388608
#  net.core.wmem_max: 8388608
  net.core.wmem_max: 12582912
  net.core.rmem_max: 12582912

  ##  You also need to set minimum size, initial size, and maximum size in bytes:
  net.ipv4.tcp_rmem: '10240 87380 12582912'
  net.ipv4.tcp_wmem: '10240 87380 12582912'
  net.ipv4.tcp_mem: '12582912 12582912 12582912'

  ## Turn on window scaling which can be an option to enlarge the transfer window:
  net.ipv4.tcp_window_scaling: 1

  ## Enable select acknowledgments:
  net.ipv4.tcp_sack: 1

  ## By default, TCP saves various connection metrics in the route cache when the connection closes,
  ## so that connections established in the near future can use these to set initial conditions.
  ## Usually, this increases overall performance, but may sometimes cause performance degradation.
  ## If set, TCP will not cache metrics on closing connections.
  net.ipv4.tcp_no_metrics_save: 1

  ## Set maximum number of packets, queued on the INPUT side, when the interface receives packets faster than kernel can process them.
  net.core.netdev_max_backlog: 5000



#
#bootstrap_linux__network:
#  network:
#    version: 2
#    renderer: networkd
#    ethernets:
#      ens192:
#        dhcp4: yes
#        dhcp6: no
##        ## ref: https://www.oxcrag.net/2019/02/07/creating-a-working-ubuntu-18-04-vmware-template/
##        dhcp-identifier: mac
#        set-name: ens192
#


### bootstrap-node
### awstats
#awstats_enabled: no
##awstats_domain: "dettonville.org"
#awstats_domain: "johnson.local"
#apache_vhosts_awstats:
#  - {servername: "localhost", serveradmin: "admin@dettonville.org", documentroot: "/usr/lib/cgi-bin"}

### IPA
### ref: https://github.com/nathancurry/homelab.ansible/tree/master
#searchdomain: 'dettonville.int'
#
#ipaserver_domain: 'dettonville.int'
#ipaserver_realm: 'DETTONVILLE.INT'
#ipaserver_forwarders:
#  - 192.168.30.2
#  - 192.168.30.3
#ipaserver_no_reverse: false
#ipaserver_setup_dns: yes
#
#ipaclient_domain: 'dettonville.int'
#ipaclient_no_ntp: 'yes'
#
#freeipa_server: 'ipa1.dettonville.int'
#
